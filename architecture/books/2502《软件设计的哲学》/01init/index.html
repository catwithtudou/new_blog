
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Life">
      
      
        <meta name="author" content="catwithtudou️">
      
      
        <link rel="canonical" href="https://zhengyua.cn/new_blog/architecture/books/2502%E3%80%8A%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%93%B2%E5%AD%A6%E3%80%8B/01init/">
      
      
        <link rel="prev" href="../../2411%E3%80%8A%E4%BA%BA%E6%9C%88%E7%A5%9E%E8%AF%9D%E3%80%8B/03init/">
      
      
        <link rel="next" href="../02init/">
      
      
      <link rel="icon" href="../../../../assets/logo.jpeg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>01~08 - catwithtudou️🌦️</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-WZVK8HDP5T"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-WZVK8HDP5T",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-WZVK8HDP5T",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#0108" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="catwithtudou️🌦️" class="md-header__button md-logo" aria-label="catwithtudou️🌦️" data-md-component="logo">
      
  <img src="../../../../assets/logo.jpeg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            catwithtudou️🌦️
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              01~08
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/catwithtudou" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    catwithtudou
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
    
  
  🌦️Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../blog/" class="md-tabs__link">
          
  
    
  
  📌MainPage

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../language/" class="md-tabs__link">
          
  
    
  
  Language

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../algorithms/" class="md-tabs__link">
          
  
    
  
  Algorithms

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../os/" class="md-tabs__link">
          
  
    
  
  OS

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../network/" class="md-tabs__link">
          
  
    
  
  Network

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../ds/" class="md-tabs__link">
          
  
    
  
  DS

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../" class="md-tabs__link">
          
  
    
  
  Architecture

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../middleware/" class="md-tabs__link">
          
  
    
  
  Middleware

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../project/" class="md-tabs__link">
          
  
    
  
  Project

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../common/01-100_tips/" class="md-tabs__link">
          
  
    
  
  Common

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="catwithtudou️🌦️" class="md-nav__button md-logo" aria-label="catwithtudou️🌦️" data-md-component="logo">
      
  <img src="../../../../assets/logo.jpeg" alt="logo">

    </a>
    catwithtudou️🌦️
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/catwithtudou" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    catwithtudou
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    🌦️Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../blog/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    📌MainPage
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../language/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Language
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../algorithms/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Algorithms
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../os/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    OS
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../network/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Network
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../ds/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    DS
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    books
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_8_2" id="__nav_8_2_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8_2">
            <span class="md-nav__icon md-icon"></span>
            books
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../2403%E3%80%8A%E9%87%8D%E6%9E%84%EF%BC%9A%E6%94%B9%E5%96%84%E6%97%A2%E6%9C%89%E4%BB%A3%E7%A0%81%E7%9A%84%E8%AE%BE%E8%AE%A1%E3%80%8B/01refactor/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    2403《重构：改善既有代码的设计》
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../2406%E3%80%8A%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E3%80%8B/01init/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    2406《代码整洁之道》
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../2411%E3%80%8A%E4%BA%BA%E6%9C%88%E7%A5%9E%E8%AF%9D%E3%80%8B/01init/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    2411《人月神话》
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2_5" checked>
        
          
          <label class="md-nav__link" for="__nav_8_2_5" id="__nav_8_2_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    2502《软件设计的哲学》
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_2_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8_2_5">
            <span class="md-nav__icon md-icon"></span>
            2502《软件设计的哲学》
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    01~08
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    01~08
    
  </span>
  

      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-前言" class="md-nav__link">
    <span class="md-ellipsis">
      0. 前言
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#第1章-介绍" class="md-nav__link">
    <span class="md-ellipsis">
      第1章 介绍
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#第2章-复杂性的本质" class="md-nav__link">
    <span class="md-ellipsis">
      第2章 复杂性的本质
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#第3章-工作代码是不够的" class="md-nav__link">
    <span class="md-ellipsis">
      第3章 工作代码是不够的
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#第4章-模块应该是深的" class="md-nav__link">
    <span class="md-ellipsis">
      第4章 模块应该是深的
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#第5章-信息隐藏和泄漏" class="md-nav__link">
    <span class="md-ellipsis">
      第5章 信息隐藏（和泄漏）
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#第6章-通用模块更深入" class="md-nav__link">
    <span class="md-ellipsis">
      第6章 通用模块更深入
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#第7章-不同的层不同的抽象" class="md-nav__link">
    <span class="md-ellipsis">
      第7章 不同的层，不同的抽象
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#第8章-降低复杂性" class="md-nav__link">
    <span class="md-ellipsis">
      第8章 降低复杂性
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../02init/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    09~15
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../03init/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    16~20
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../04init/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    结论&amp;总结
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../middleware/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Middleware
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../project/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Project
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../common/01-100_tips/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Common
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="0108">01~08<a class="headerlink" href="#0108" title="Permanent link">&para;</a></h1>
<h2 id="0-前言">0. 前言<a class="headerlink" href="#0-前言" title="Permanent link">&para;</a></h2>
<p><strong>1. 软件设计的缺失讨论</strong></p>
<ul>
<li>
<p>过去80年软件开发更关注流程（如敏捷）、工具（如版本控制）和编程范式（如面向对象），但关于<strong>如何设计高质量软件的核心问题</strong>长期未被深入探讨</p>
</li>
<li>
<p>作者指出1971年David Parnas的模块分解论文仍是该领域重要参考，暗示软件设计方法论进展缓慢</p>
</li>
</ul>
<p><strong>2. 核心问题：问题分解</strong></p>
<ul>
<li>
<p>计算机科学最根本挑战是<strong>将复杂问题拆分为可独立解决的模块</strong>，但学术界鲜有系统化教学</p>
</li>
<li>
<p>当前教育更侧重编程语法（如循环语句）而非设计思维训练</p>
</li>
</ul>
<p><strong>3. 程序员能力差异的根源</strong></p>
<ul>
<li>
<p>优秀程序员与普通程序员的核心差异在于设计能力，而非天赋</p>
</li>
<li>
<p>作者通过斯坦福CS190课程实践"写作式教学法"：通过迭代开发→代码评审→重构改进的模式，帮助学生实践设计原则</p>
</li>
</ul>
<p><strong>4. 本书的实践基础</strong></p>
<ul>
<li>
<p>内容提炼自作者25万行代码的实战经验，涵盖操作系统、工具链、脚本语言等领域</p>
</li>
<li>
<p>设计原则强调哲学层面（如"消除错误的存在"），需通过具体编码实践理解</p>
</li>
</ul>
<p><strong>5. 开放性态度</strong></p>
<ul>
<li>作者声明本书非终极答案，鼓励读者结合自身经验辩证吸收</li>
</ul>
<h2 id="第1章-介绍">第1章 介绍<a class="headerlink" href="#第1章-介绍" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">关键结论</p>
<p>软件设计是持续对抗复杂性的过程，优秀设计应使系统复杂度增速低于功能需求增速。</p>
<p>开发者需像作家反复润色文稿一样，通过迭代重构逼近理想设计状态。</p>
</div>
<p><strong>1. 软件复杂性的本质</strong></p>
<p><strong>核心命题</strong>：软件开发的最大障碍是<strong>认知复杂性</strong>。程序员受限于理解不断膨胀的系统复杂性，导致开发效率下降、错误率上升。</p>
<p><strong>复杂性来源</strong>：</p>
<ul>
<li>组件间隐式依赖</li>
<li>功能迭代导致的逻辑交织</li>
<li>多人协作带来的设计理念冲突</li>
</ul>
<p><strong>2. 对抗复杂性的两种策略</strong></p>
<table>
<thead>
<tr>
<th><strong>策略</strong></th>
<th><strong>具体方法</strong></th>
<th><strong>关键示例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>消除复杂性</strong></td>
<td>通过简化代码逻辑降低认知负荷</td>
<td>统一命名规范，消除冗余条件分支</td>
</tr>
<tr>
<td><strong>封装复杂性</strong></td>
<td>模块化设计实现关注点分离</td>
<td>类/服务隔离实现，隐藏内部实现细节</td>
</tr>
</tbody>
</table>
<p><strong>3. 软件开发模型对比</strong></p>
<ul>
<li>
<p><strong>瀑布模型缺陷</strong>：</p>
<ul>
<li>预设完整设计在复杂系统中不可行</li>
<li>后期修改成本指数级增长（如桥梁中途改结构）</li>
</ul>
</li>
<li>
<p><strong>增量开发优势</strong>：</p>
<ul>
<li>允许持续重构（如敏捷开发）</li>
<li>每个迭代周期暴露设计缺陷</li>
<li>早期经验优化后续功能实现</li>
</ul>
</li>
</ul>
<p><strong>4. 软件设计的持续性特征</strong></p>
<ul>
<li>
<p><strong>设计即重构</strong>：初始设计必然存在缺陷，需通过：</p>
<ul>
<li>代码审查（他人视角发现设计问题）</li>
<li>危险信号识别（如过度嵌套/重复模式）</li>
<li>定期投入10-20%时间进行设计优化</li>
</ul>
</li>
<li>
<p><strong>设计平衡观</strong>：</p>
<ul>
<li>警惕过度设计（如"Taking it too far"章节）</li>
<li>类深度 vs 接口简洁的权衡</li>
</ul>
</li>
</ul>
<p><strong>5. 实践建议</strong></p>
<ul>
<li>
<p><strong>学习路径</strong>：</p>
<ul>
<li>通过真实代码审查理解设计原则</li>
<li>建立个人"危险信号"清单（如过长嵌套/模糊命名）</li>
</ul>
</li>
<li>
<p><strong>技术普适性</strong>：</p>
<ul>
<li>虽然示例使用Java/C++，原则适用于C函数/微服务等场景</li>
<li>核心思想：<strong>通过抽象层级控制认知负载</strong></li>
</ul>
</li>
</ul>
<h2 id="第2章-复杂性的本质">第2章 复杂性的本质<a class="headerlink" href="#第2章-复杂性的本质" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">关键结论</p>
<ul>
<li><strong>复杂性定律</strong>：软件维护成本 = f(依赖性×模糊性)</li>
<li><strong>设计者的使命</strong>：通过降低模块耦合度、提升信息可见性，使系统复杂度增速 &lt;&lt; 功能需求增速</li>
<li><strong>终极检验标准</strong>：新成员能否在无文档情况下，凭直觉正确修改系统核心功能？</li>
</ul>
<p>（第3章将具体探讨如何在日常开发中实践"零容忍"原则对抗复杂性）</p>
</div>
<p><strong>1. 复杂性的本质定义</strong></p>
<ul>
<li><strong>核心定义</strong>：任何导致系统<strong>难以理解和修改</strong>的软件结构特征<ul>
<li><strong>关键视角</strong>：以开发者<strong>完成具体任务时的体验</strong>为衡量标准，而非系统规模</li>
<li><strong>数学表达</strong>：系统总复杂度 = Σ（各模块复杂度 × 开发者投入该模块的时间占比）</li>
<li><strong>黄金法则</strong>：若他人认为你的代码复杂，则它就是复杂的（开发者的主观感受具有决定性）</li>
</ul>
</li>
</ul>
<p><strong>2. 复杂性三大症状</strong></p>
<table>
<thead>
<tr>
<th><strong>症状</strong></th>
<th><strong>表现特征</strong></th>
<th><strong>典型案例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>变更放大</strong></td>
<td>简单修改需要调整多处代码</td>
<td>早期网站每个页面硬编码背景色，修改需遍历所有文件（图2.1a → 2.1b的改进）</td>
</tr>
<tr>
<td><strong>认知负荷</strong></td>
<td>完成任务需掌握大量隐式知识</td>
<td>C语言函数要求调用者手动释放内存，开发者必须记住此规则否则引发内存泄漏</td>
</tr>
<tr>
<td><strong>未知的未知</strong></td>
<td>无法预知修改会对哪些模块产生影响</td>
<td>修改中心背景色变量后，未发现某些页面使用其衍生色（图2.1c的强调色未同步更新）</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>危害排序</strong>：未知的未知 &gt; 认知负荷 &gt; 变更放大</p>
<p><strong>设计目标</strong>：通过"显而易见性(Obviousness)"对抗复杂性（第18章具体方法）</p>
</blockquote>
<p><strong>3. 复杂性的根本成因</strong></p>
<p><strong>Ⅰ 依赖性(Dependencies)</strong></p>
<ul>
<li><strong>定义</strong>：代码修改必须联动调整其他相关部分</li>
<li><strong>典型场景</strong>：<ul>
<li><strong>显性依赖</strong>：函数参数变更导致所有调用点需修改</li>
<li><strong>隐性依赖</strong>：多模块共享全局状态（如旧版网站背景色分散定义）</li>
</ul>
</li>
<li><strong>管理原则</strong>：<ul>
<li><strong>隔离高频修改点</strong>（如现代网站集中管理颜色变量）</li>
<li><strong>通过编译器强制</strong>（如变量重命名触发编译错误）</li>
</ul>
</li>
</ul>
<p><strong>Ⅱ 模糊性(Obscurity)</strong></p>
<ul>
<li><strong>定义</strong>：关键信息未被清晰传达</li>
<li><strong>表现形式</strong>：<ul>
<li><strong>命名不当</strong>：<code>time</code>变量未说明是秒/毫秒</li>
<li><strong>文档缺失</strong>：错误码对应含义未记录</li>
<li><strong>隐性约定</strong>：消息表与状态声明无显式关联</li>
</ul>
</li>
<li><strong>根治方法</strong>：<ul>
<li><strong>自解释设计</strong> &gt; 补充文档（第13章详述）</li>
<li><strong>保持一致性</strong>（如禁用多用途变量名）</li>
</ul>
</li>
</ul>
<p><strong>4. 复杂性的递增特性</strong></p>
<ul>
<li><strong>累积机制</strong>：每个看似无害的微小设计缺陷（如一个模糊命名）叠加产生指数级维护成本</li>
<li><strong>反直觉现象</strong>：<ul>
<li>单一依赖/模糊性问题危害不大</li>
<li>但千级规模代码需面对<strong>网状交叉影响</strong></li>
</ul>
</li>
<li><strong>防御策略</strong>：<ul>
<li><strong>零容忍哲学</strong>：每个提交都力求简化设计（第3章展开）</li>
<li><strong>持续重构</strong>：像偿还技术债务一样修复微小缺陷</li>
</ul>
</li>
</ul>
<h2 id="第3章-工作代码是不够的">第3章 工作代码是不够的<a class="headerlink" href="#第3章-工作代码是不够的" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">关键结论</p>
<p><strong>好的设计需要持续投资</strong>，但它最终会带来回报，而且比想象中更快。关键是：</p>
<ul>
<li>保持一致地应用战略方法</li>
<li>将投资视为今天要做的事，而非推迟到明天</li>
<li>每个工程师都持续进行小规模的设计改进</li>
<li>避免"滑坡效应"——一旦开始推迟设计改进，很容易变成永久性延迟</li>
</ul>
<p><strong>核心启示</strong>：虽然战术编程可能带来短期收益，但从长远来看，战略编程是构建可持续、高质量软件系统的唯一途径。</p>
</div>
<p><strong>1. 战术编程 vs 战略编程</strong></p>
<p><strong>战术编程</strong>和<strong>战略编程</strong>是两种截然不同的软件开发思维方式，它们的区别在于：</p>
<table>
<thead>
<tr>
<th>战术编程</th>
<th>战略编程</th>
</tr>
</thead>
<tbody>
<tr>
<td>关注当下任务的快速完成</td>
<td>关注系统的长期结构和质量</td>
</tr>
<tr>
<td>短视的、功能驱动的</td>
<td>投资思维、设计驱动的</td>
</tr>
<tr>
<td>渐进式增加复杂性</td>
<td>持续性改进系统设计</td>
</tr>
<tr>
<td>优先考虑短期速度</td>
<td>优先考虑长期可维护性</td>
</tr>
<tr>
<td>倾向于避免重构</td>
<td>主动进行设计改进和重构</td>
</tr>
</tbody>
</table>
<p><strong>2. 战术编程的问题</strong></p>
<p><strong>战术编程的核心问题是短视</strong>。当开发者只关注快速完成当前任务时，会导致：</p>
<ul>
<li>复杂性逐渐累积，没有人愿意花时间清理</li>
<li>代码质量持续下降，系统逐渐变得难以维护</li>
<li>形成"补丁上加补丁"的恶性循环</li>
<li>长期来看，开发速度显著降低</li>
</ul>
<p>在一些组织中，存在"<strong>战术龙卷风</strong>"式的开发者——他们能极快地开发功能，但留下的代码质量差，需要其他开发者花费大量时间清理。</p>
<p><strong>3. 战略编程的本质</strong></p>
<p>战略编程的核心理念是：<strong>能工作的代码是不够的</strong>。开发者需要：</p>
<ul>
<li>将系统的长期结构作为首要考虑因素</li>
<li>愿意投入时间改进设计，即使短期内会放慢速度</li>
<li>采取主动投资（找到简单设计、预见未来变化）和被动投资（发现问题时修复）</li>
<li><strong>建议投入总开发时间的10-20%用于设计投资</strong></li>
</ul>
<p><strong>4. 投资回报曲线</strong></p>
<p><img alt="" src="https://img.zhengyua.cn/blog/202503110959991.png" /></p>
<ul>
<li><strong>短期</strong>：战术方法看似更快，战略方法因投资设计而略慢</li>
<li><strong>中期</strong>：战术方法积累的复杂性开始减缓开发速度，战略方法因良好设计开始加速</li>
<li><strong>长期</strong>：战略方法明显更快，且投资变为"免费"——过去投资节省的时间足以覆盖未来投资</li>
</ul>
<p><strong>5. 创业公司的挑战与选择</strong></p>
<p>创业公司面临更大的交付压力，但仍有两种截然不同的路径：</p>
<ol>
<li>
<p><strong>Facebook模式</strong>："快速行动并打破常规"的战术方法
   - 短期交付速度较快
   - 代码库逐渐变得混乱难以维护
   - 最终不得不改变方向："以坚实的基础架构快速移动"</p>
</li>
<li>
<p><strong>Google/VMware模式</strong>：战略性方法
   - 注重高质量代码和良好设计
   - 构建可靠的复杂系统
   - 吸引顶尖技术人才的强大技术文化</p>
</li>
</ol>
<h2 id="第4章-模块应该是深的">第4章 模块应该是深的<a class="headerlink" href="#第4章-模块应该是深的" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">关键结论</p>
<p>通过分离接口和实现，我们可以将实现的复杂性从系统的其余部分隐藏起来。设计类和模块的关键是<strong>使它们深入</strong>，为常见用例提供简单接口，同时提供重要功能。这最大限度地隐藏了复杂性。</p>
<p><strong>核心思想</strong>：模块设计应该追求"深度"——用简单接口暴露强大功能，而非"宽度"——大量功能简单但接口复杂的浅层模块。</p>
</div>
<p><strong>1. 模块化设计的本质</strong></p>
<p>模块化设计是管理软件复杂性的关键技术，它允许开发人员<strong>在任何时刻只需面对整体复杂性的一小部分</strong>。在软件系统中，模块可以是类、子系统或服务等多种形式。</p>
<p><strong>理想的模块化</strong>：每个模块完全独立，开发者可以在不了解其他模块的情况下工作。但这个理想无法完全实现，因为模块之间必须协同工作，这就产生了依赖关系。</p>
<p><strong>模块化设计的目标</strong>：最小化模块之间的依赖性。</p>
<p><strong>2. 模块的接口与实现</strong></p>
<p>每个模块由两个关键部分组成：</p>
<table>
<thead>
<tr>
<th>接口</th>
<th>实现</th>
</tr>
</thead>
<tbody>
<tr>
<td>其他模块开发者需要了解的内容</td>
<td>实现接口承诺的代码</td>
</tr>
<tr>
<td>描述"做什么"，而非"怎么做"</td>
<td>实现具体功能的内部细节</td>
</tr>
<tr>
<td>包括形式化元素(函数签名)和非形式化元素(行为、约束)</td>
<td>对模块用户隐藏</td>
</tr>
</tbody>
</table>
<p><strong>良好接口的价值</strong>：它准确指示开发人员使用模块所需了解的内容，帮助消除"未知的未知"问题。</p>
<p><strong>3. 抽象的概念</strong></p>
<p><strong>抽象</strong>是实体的简化视图，省略了不重要的细节。在模块化编程中，每个模块通过其接口提供抽象。</p>
<p>抽象可能出现的两类错误：</p>
<ol>
<li><strong>包含了不重要的细节</strong>：使抽象比必要的更复杂，增加认知负担</li>
<li><strong>省略了重要的细节</strong>：导致模糊性，用户无法正确使用抽象</li>
</ol>
<p><strong>设计抽象的关键</strong>是识别什么是重要的，并寻找能将重要信息量最小化的设计。</p>
<p><strong>4. 深度模块与浅层模块</strong></p>
<p><strong>4.1. 深度模块</strong></p>
<p><strong>深度模块</strong>提供强大功能但拥有简单接口，它们是好的抽象，因为只有很小一部分内部复杂性对用户可见。</p>
<p>深度模块可以用矩形来可视化：</p>
<ul>
<li>矩形面积 = 模块实现的功能</li>
<li>顶部边缘长度 = 接口复杂性</li>
<li>最好的模块是"深的"矩形：面积大但顶边短</li>
</ul>
<p><strong>深度模块的优点</strong>：</p>
<ul>
<li>最小化模块给系统其它部分带来的复杂性</li>
<li>如果修改不改变接口，则不会影响其他模块</li>
</ul>
<p><strong>深度模块的例子</strong>：</p>
<ul>
<li><strong>Unix文件I/O</strong>：仅有5个基本系统调用（open, read, write, lseek, close），但实现了数十万行代码处理的复杂功能</li>
<li><strong>垃圾收集器</strong>：几乎没有接口，在后台工作，但隐藏了复杂的内存回收机制</li>
</ul>
<p><strong>4.2 浅层模块</strong></p>
<p><strong>浅层模块</strong>的接口相对于其提供的功能而言过于复杂。</p>
<p><strong>浅层模块的问题</strong>：</p>
<ul>
<li>学习和使用接口的成本抵消了它提供的收益</li>
<li>没有显著帮助管理复杂性</li>
</ul>
<p><strong>极端例子</strong>：只有一行代码的方法<code>addNullValueForAttribute</code>，它增加了接口复杂性但没有提供任何抽象价值。</p>
<p><strong>5. Classitis</strong></p>
<p>当前编程中常见的误区是"类应该小"。这种思维导致了 <strong>Classitis</strong>：错误地认为"类是好的，所以类越多越好"。</p>
<p><strong>Classitis 的问题</strong>：</p>
<ul>
<li>小类单独可能简单，但增加了系统总体复杂性</li>
<li>需要大量小类，每个都有自己的接口</li>
<li>接口累积创造了系统级的巨大复杂性</li>
<li>导致冗长的编程风格</li>
</ul>
<p><strong>示例对比</strong>：</p>
<ul>
<li><strong>Java I/O</strong>：打开一个文件读取序列化对象需要创建三个不同对象（FileInputStream, BufferedInputStream, ObjectInputStream）</li>
<li><strong>Unix I/O</strong>：设计者使常见情况简单，默认提供顺序I/O，而随机访问作为可选功能</li>
</ul>
<p><strong>6. 关键设计原则</strong></p>
<p><strong>接口设计的重要原则</strong>：<strong>应该设计接口以使常见情况尽可能简单</strong>。例如，若大多数用户需要缓冲，则应默认提供缓冲。</p>
<p>如果接口有许多功能，但大多数开发者只需了解其中几个，那么接口的<strong>有效复杂性</strong>就是常用功能的复杂性。</p>
<h2 id="第5章-信息隐藏和泄漏">第5章 信息隐藏（和泄漏）<a class="headerlink" href="#第5章-信息隐藏和泄漏" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">关键结论</p>
<p><strong>信息隐藏与深层模块紧密相关</strong>：
- 隐藏大量信息的模块通常功能丰富但接口简单，因此更深入
- 不隐藏信息的模块要么功能有限，要么接口复杂，通常是浅层的</p>
<p>系统分解的最佳方法是：
- 避免受运行时操作顺序影响（时间分解）
- 思考应用程序任务所需的不同知识
- 设计每个模块来封装这些知识中的一个或几个
- 这将产生干净、简单且深入的模块设计</p>
<p><strong>核心思想</strong>：好的模块设计应该围绕知识封装而非时间顺序，通过隐藏实现细节来降低系统整体复杂性。</p>
</div>
<p><strong>1. 信息隐藏的本质</strong></p>
<p><strong>信息隐藏</strong>是实现深层模块的最重要技术，由 David Parnas 首次提出。其核心思想是：<strong>每个模块应封装代表设计决策的知识，这些知识嵌入在模块实现中但不出现在接口中</strong>。</p>
<p>模块中隐藏的信息通常包括：</p>
<ul>
<li>实现特定机制的数据结构和算法</li>
<li>较低级别的技术细节</li>
<li>较高级别的抽象概念和假设</li>
</ul>
<p><strong>2. 信息隐藏的双重价值</strong></p>
<p>信息隐藏通过两种方式降低复杂性：</p>
<table>
<thead>
<tr>
<th>价值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>简化接口</strong></td>
<td>提供更简单、更抽象的功能视图，隐藏细节，减少使用模块的开发人员的认知负担</td>
</tr>
<tr>
<td><strong>促进系统演化</strong></td>
<td>由于封装了知识，对相关设计决策的更改只会影响单个模块，而不会波及整个系统</td>
</tr>
</tbody>
</table>
<p><strong>3. 信息泄漏与其危害</strong></p>
<p><strong>信息泄漏</strong>是信息隐藏的反面，当一个设计决策反映在多个模块中时发生。这创建了模块间依赖关系：对该设计决策的任何更改都需要修改所有涉及模块。</p>
<p>信息可以通过两种方式泄漏：</p>
<ul>
<li><strong>通过接口泄漏</strong>：设计信息直接出现在接口中</li>
<li><strong>后门泄漏</strong>：即使不在接口中，多个模块都依赖同一知识（如文件格式）</li>
</ul>
<p><strong>信息泄漏是软件设计中最重要的危险信号之一</strong>。应当培养对信息泄漏的高度敏感性，发现后应考虑重组类结构。</p>
<p><strong>4. 时间分解：信息泄漏的常见原因</strong></p>
<p><strong>时间分解</strong>是一种设计风格，系统结构对应于操作将发生的时间顺序。这常导致信息泄漏，因为：</p>
<ul>
<li>相同知识可能在不同时间点使用</li>
<li>将相关功能分散到多个类中</li>
</ul>
<p>🚩 <strong>关键原则</strong>：在设计模块时，应<strong>关注执行每个任务所需的知识，而非任务发生的顺序</strong>。</p>
<p><strong>5. 实例分析：HTTP服务器</strong></p>
<p><strong>5.1 问题1：太多浅层类</strong></p>
<p>一些学生团队犯的错误是将HTTP请求处理分成两个类：一个读取请求，一个解析请求。这是时间分解的例子，导致了信息泄漏，因为：</p>
<ul>
<li>读取HTTP请求需要解析大部分消息</li>
<li>两个类都需要了解HTTP请求的结构</li>
<li>解析代码在两个类中重复</li>
</ul>
<p><strong>解决方案</strong>：将相关功能合并到一个类中，提供更好的信息隐藏和更简单的接口。</p>
<p><strong>5.2 改进信息隐藏的一般策略：适当增大类的规模</strong></p>
<ol>
<li>将相关功能集中到一起</li>
<li>提高接口级别（用一个高级方法替代多个低级方法）</li>
<li>结果：接口更简单，类更深入</li>
</ol>
<p><strong>5.3 问题2：HTTP参数处理</strong></p>
<p>大多数学生项目在参数处理方面有两个好的设计决策：</p>
<ol>
<li>隐藏参数来源（请求行vs请求体）的区别</li>
<li>隐藏URL编码的知识（自动解码）</li>
</ol>
<p>但他们使用了太浅的接口：</p>
<div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><a href="#__codelineno-0-1"><span class="linenos" data-linenos="1 "></span></a><span class="kd">public</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getParams</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><a href="#__codelineno-0-2"><span class="linenos" data-linenos="2 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">params</span><span class="p">;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><a href="#__codelineno-0-3"><span class="linenos" data-linenos="3 "></span></a><span class="p">}</span>
</code></pre></div>
<p>这种设计的问题：</p>
<ul>
<li>暴露内部表示</li>
<li>任何实现变更都会影响接口</li>
<li>增加调用者工作量</li>
<li>调用者可能无意修改内部状态</li>
</ul>
<p><strong>更好的接口设计</strong>：</p>
<div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><a href="#__codelineno-1-1"><span class="linenos" data-linenos="1 "></span></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getParameter</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><a href="#__codelineno-1-2"><span class="linenos" data-linenos="2 "></span></a><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getIntParameter</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<p>这种设计：</p>
<ul>
<li>隐藏内部实现</li>
<li>提供类型转换功能</li>
<li>简化调用</li>
</ul>
<p><strong>5.4 问题3：HTTP响应中的默认值</strong></p>
<p>一些团队要求调用者显式指定HTTP响应的版本和时间，而这些信息通常可以自动从请求推断或系统获取。</p>
<p><strong>改进原则</strong>：</p>
<ul>
<li><strong>接口应设计为使常见情况尽可能简单</strong></li>
<li>默认值是部分信息隐藏的例子：通常情况下用户不需要知道这些细节</li>
<li>类应当"自动做正确的事"，无需显式要求</li>
</ul>
<p><strong>6. 类内部的信息隐藏</strong></p>
<p>信息隐藏也适用于类内部：</p>
<ul>
<li>设计私有方法来封装和隐藏信息</li>
<li>尽量减少实例变量的使用范围</li>
<li>降低类内部的依赖关系和复杂性</li>
</ul>
<p><strong>7. 信息隐藏的界限</strong></p>
<p>信息隐藏并非放之四海而皆准：<strong>如果模块外部需要某信息，就不应隐藏它</strong>。</p>
<p>作为设计者，目标应该是：</p>
<ul>
<li><strong>尽量减少模块外部需要的信息量</strong></li>
<li><strong>优先考虑自动调整而非暴露配置参数</strong></li>
<li><strong>正确识别哪些信息确实需要公开</strong></li>
</ul>
<h2 id="第6章-通用模块更深入">第6章 通用模块更深入<a class="headerlink" href="#第6章-通用模块更深入" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">关键结论</p>
<p>通用接口比专用接口具有明显优势：</p>
<ul>
<li>更简单，方法更少但更深入</li>
<li>提供更清晰的类间分离</li>
<li>减少类间信息泄漏</li>
<li><strong>适度通用化是降低整体系统复杂性的最佳方法之一</strong></li>
</ul>
<p>通用方法并非万能，但在设计时应尽量使模块"有点通用"，<strong>在当前需求与未来扩展之间找到平衡点</strong>。</p>
</div>
<p><strong>1. 核心理念</strong></p>
<p>通用模块方法在软件设计中比专用模块方法更优越，能创建<strong>更简单、更深入的接口</strong>，实现更清晰的类间分离，并降低整体系统复杂性。</p>
<p><strong>2. 通用与专用方法对比</strong></p>
<table>
<thead>
<tr>
<th>通用方法</th>
<th>专用方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>✅ 更简单、更深入的接口</td>
<td>❌ 大量浅层方法</td>
</tr>
<tr>
<td>✅ 更清晰的模块间分离</td>
<td>❌ 模块间信息泄漏</td>
</tr>
<tr>
<td>✅ 降低认知负担</td>
<td>❌ 提高认知负担</td>
</tr>
<tr>
<td>✅ 更好的信息隐藏</td>
<td>❌ 造成虚假抽象</td>
</tr>
<tr>
<td>✅ 潜在的可重用性</td>
<td>❌ 难以用于其他场景</td>
</tr>
</tbody>
</table>
<p><strong>3. 关键原则：适度通用</strong></p>
<p>作者提出"<strong>somewhat general-purpose</strong>"（适度通用）的概念：</p>
<ul>
<li>模块的<strong>功能</strong>应反映当前需求</li>
<li>但<strong>接口</strong>不应被当前需求限制，而应足够通用以支持多种用途</li>
<li>接口应便于满足当前需求，但不应与特定需求紧密耦合</li>
<li>不要过度通用化而难以满足当前需求</li>
</ul>
<p><strong>4. 案例分析：文本编辑器</strong></p>
<p>通过文本编辑器的设计案例对比了两种方法：</p>
<p><strong>专用方法</strong>（不推荐）：</p>
<div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><a href="#__codelineno-2-1"><span class="linenos" data-linenos="1 "></span></a><span class="kt">void</span><span class="w"> </span><span class="nf">backspace</span><span class="p">(</span><span class="n">Cursor</span><span class="w"> </span><span class="n">cursor</span><span class="p">);</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><a href="#__codelineno-2-2"><span class="linenos" data-linenos="2 "></span></a><span class="kt">void</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="n">Cursor</span><span class="w"> </span><span class="n">cursor</span><span class="p">);</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><a href="#__codelineno-2-3"><span class="linenos" data-linenos="3 "></span></a><span class="kt">void</span><span class="w"> </span><span class="nf">deleteSelection</span><span class="p">(</span><span class="n">Selection</span><span class="w"> </span><span class="n">selection</span><span class="p">);</span>
</code></pre></div>
<p><strong>通用方法</strong>（推荐）：
<div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><a href="#__codelineno-3-1"><span class="linenos" data-linenos="1 "></span></a><span class="kt">void</span><span class="w"> </span><span class="nf">insert</span><span class="p">(</span><span class="n">Position</span><span class="w"> </span><span class="n">position</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">newText</span><span class="p">);</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><a href="#__codelineno-3-2"><span class="linenos" data-linenos="2 "></span></a><span class="kt">void</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="n">Position</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="n">end</span><span class="p">);</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><a href="#__codelineno-3-3"><span class="linenos" data-linenos="3 "></span></a><span class="n">Position</span><span class="w"> </span><span class="nf">changePosition</span><span class="p">(</span><span class="n">Position</span><span class="w"> </span><span class="n">position</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">numChars</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>通用方法的优势</strong>：</p>
<ul>
<li>操作基于基本文本概念，而非特定UI功能</li>
<li>使用通用类型（如<code>Position</code>代替<code>Cursor</code>）</li>
<li>减少了方法数量但保持了完整功能</li>
<li>提供了更清晰的类间分离</li>
<li>使高层实现（如退格和删除操作）更加明确</li>
</ul>
<p><strong>5. 判断好设计的问题</strong></p>
<p>设计通用接口时可以自问的问题：</p>
<p>a. <strong>什么是满足当前需求的最简单接口？</strong></p>
<ul>
<li>减少方法数量但保持功能完整性</li>
<li>简化不应导致参数过度复杂化</li>
</ul>
<p>b. <strong>这个方法会在多少情况下使用？</strong></p>
<ul>
<li>单一用途方法可能过于特殊化</li>
<li>尝试用通用方法替换多个专用方法</li>
</ul>
<p>c. <strong>这个API对当前需求易用吗？</strong></p>
<ul>
<li>过度简化可能导致使用复杂</li>
<li>应提供适当级别的抽象（如文本类支持字符范围操作）</li>
</ul>
<h2 id="第7章-不同的层不同的抽象">第7章 不同的层，不同的抽象<a class="headerlink" href="#第7章-不同的层不同的抽象" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">关键结论</p>
<p>每增加一个设计元素（接口、参数、函数、类等）都会增加系统复杂性。<strong>要使元素对复杂性有净收益，它必须消除在没有该设计元素情况下存在的复杂性</strong>。</p>
<p>"不同层，不同抽象"原则的本质是：如果不同层使用相同抽象（如透传方法、装饰器或透传参数），<strong>这些层很可能没有提供足够的价值来补偿它们带来的额外复杂性</strong>。</p>
</div>
<p><strong>1. 核心概念</strong></p>
<p>软件系统由多个层组成，其中较高层使用较低层提供的功能。<strong>在设计良好的系统中，每一层都应提供与其上下层不同的抽象</strong>。当一个操作通过方法调用在层之间移动时，抽象应随每次方法调用而改变。</p>
<p><strong>2. 问题识别：相似抽象的危害</strong></p>
<p>当系统中相邻层具有相似抽象时，这表明类分解可能存在问题。这种情况通常表现为：</p>
<table>
<thead>
<tr>
<th>问题类型</th>
<th>定义</th>
<th>危害</th>
<th>解决思路</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>透传方法</strong><br>(Pass-through Methods)</td>
<td>一个方法除了将参数传递给另一个具有相同API的方法外，几乎不执行任何操作</td>
<td>• 使类变浅：增加接口复杂性但不增加功能<br>• 创建类间依赖：一个类的签名更改导致另一类需同步修改<br>• 表明类间责任划分混乱或重叠</td>
<td>• 直接暴露底层类<br>• 重新分配类间功能<br>• 合并职责相关的类</td>
</tr>
<tr>
<td><strong>透传变量</strong><br>(Pass-through Variables)</td>
<td>通过长方法链向下传递但在中间方法中不使用的变量</td>
<td>• 强制中间方法感知其存在<br>• 增加系统整体复杂性<br>• 新增需求时需大规模修改中间层接口</td>
<td>• 利用共享对象<br>• 使用全局变量<br>• 引入上下文对象(推荐)</td>
</tr>
</tbody>
</table>
<p><strong>3. 解决方案</strong></p>
<p><strong>3.1 处理透传方法</strong></p>
<p><img alt="" src="https://img.zhengyua.cn/blog/202503120957782.png" />)</p>
<p>可采用以下几种方式消除透传方法：</p>
<p><strong>a. 直接暴露底层类</strong>：让高层类的调用者直接调用低层类；</p>
<p><strong>b. 重新分配功能</strong>：在类之间重新分配职责，避免类间调用；</p>
<p><strong>c. 合并类</strong>：如果职责无法清晰分离，将相关类合并；</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:4"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><input id="__tabbed_1_4" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">问题示例</label><label for="__tabbed_1_2">优化:直接暴露底层类</label><label for="__tabbed_1_3">优化:重新分配功能</label><label for="__tabbed_1_4">优化:合并类</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-go highlight"><span class="filename">Go</span><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><a href="#__codelineno-4-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="c1">// TextArea 实现文本编辑的核心功能</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><a href="#__codelineno-4-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">TextArea</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><a href="#__codelineno-4-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">    </span><span class="nx">content</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><a href="#__codelineno-4-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">    </span><span class="nx">cursor</span><span class="w">  </span><span class="kt">int</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><a href="#__codelineno-4-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="p">}</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><a href="#__codelineno-4-6"><span class="linenos" data-linenos=" 6 "></span></a>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><a href="#__codelineno-4-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">TextArea</span><span class="p">)</span><span class="w"> </span><span class="nx">GetCursorOffset</span><span class="p">()</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><a href="#__codelineno-4-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">cursor</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><a href="#__codelineno-4-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="p">}</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><a href="#__codelineno-4-10"><span class="linenos" data-linenos="10 "></span></a>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><a href="#__codelineno-4-11"><span class="linenos" data-linenos="11 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">TextArea</span><span class="p">)</span><span class="w"> </span><span class="nx">InsertString</span><span class="p">(</span><span class="nx">text</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a><a href="#__codelineno-4-12"><span class="linenos" data-linenos="12 "></span></a><span class="w">    </span><span class="c1">// 实际的插入实现</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a><a href="#__codelineno-4-13"><span class="linenos" data-linenos="13 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a><a href="#__codelineno-4-14"><span class="linenos" data-linenos="14 "></span></a><span class="w">        </span><span class="nx">t</span><span class="p">.</span><span class="nx">content</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">content</span><span class="p">[:</span><span class="nx">offset</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">content</span><span class="p">[</span><span class="nx">offset</span><span class="p">:]</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a><a href="#__codelineno-4-15"><span class="linenos" data-linenos="15 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a><a href="#__codelineno-4-16"><span class="linenos" data-linenos="16 "></span></a><span class="p">}</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a><a href="#__codelineno-4-17"><span class="linenos" data-linenos="17 "></span></a>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a><a href="#__codelineno-4-18"><span class="linenos" data-linenos="18 "></span></a><span class="c1">// TextDocument 只是透传调用到 TextArea</span>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a><a href="#__codelineno-4-19"><span class="linenos" data-linenos="19 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">TextDocument</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a><a href="#__codelineno-4-20"><span class="linenos" data-linenos="20 "></span></a><span class="w">    </span><span class="nx">textArea</span><span class="w"> </span><span class="o">*</span><span class="nx">TextArea</span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a><a href="#__codelineno-4-21"><span class="linenos" data-linenos="21 "></span></a><span class="p">}</span>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a><a href="#__codelineno-4-22"><span class="linenos" data-linenos="22 "></span></a>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a><a href="#__codelineno-4-23"><span class="linenos" data-linenos="23 "></span></a><span class="c1">// 透传方法 - 只是简单地将调用传给 TextArea</span>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a><a href="#__codelineno-4-24"><span class="linenos" data-linenos="24 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">d</span><span class="w"> </span><span class="o">*</span><span class="nx">TextDocument</span><span class="p">)</span><span class="w"> </span><span class="nx">GetCursorOffset</span><span class="p">()</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a><a href="#__codelineno-4-25"><span class="linenos" data-linenos="25 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">d</span><span class="p">.</span><span class="nx">textArea</span><span class="p">.</span><span class="nx">GetCursorOffset</span><span class="p">()</span>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a><a href="#__codelineno-4-26"><span class="linenos" data-linenos="26 "></span></a><span class="p">}</span>
<a id="__codelineno-4-27" name="__codelineno-4-27"></a><a href="#__codelineno-4-27"><span class="linenos" data-linenos="27 "></span></a>
<a id="__codelineno-4-28" name="__codelineno-4-28"></a><a href="#__codelineno-4-28"><span class="linenos" data-linenos="28 "></span></a><span class="c1">// 透传方法 - 没有添加任何额外价值</span>
<a id="__codelineno-4-29" name="__codelineno-4-29"></a><a href="#__codelineno-4-29"><span class="linenos" data-linenos="29 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">d</span><span class="w"> </span><span class="o">*</span><span class="nx">TextDocument</span><span class="p">)</span><span class="w"> </span><span class="nx">InsertString</span><span class="p">(</span><span class="nx">text</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-30" name="__codelineno-4-30"></a><a href="#__codelineno-4-30"><span class="linenos" data-linenos="30 "></span></a><span class="w">    </span><span class="nx">d</span><span class="p">.</span><span class="nx">textArea</span><span class="p">.</span><span class="nx">InsertString</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="p">)</span>
<a id="__codelineno-4-31" name="__codelineno-4-31"></a><a href="#__codelineno-4-31"><span class="linenos" data-linenos="31 "></span></a><span class="p">}</span>
<a id="__codelineno-4-32" name="__codelineno-4-32"></a><a href="#__codelineno-4-32"><span class="linenos" data-linenos="32 "></span></a>
<a id="__codelineno-4-33" name="__codelineno-4-33"></a><a href="#__codelineno-4-33"><span class="linenos" data-linenos="33 "></span></a><span class="c1">// 客户端代码</span>
<a id="__codelineno-4-34" name="__codelineno-4-34"></a><a href="#__codelineno-4-34"><span class="linenos" data-linenos="34 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-35" name="__codelineno-4-35"></a><a href="#__codelineno-4-35"><span class="linenos" data-linenos="35 "></span></a><span class="w">    </span><span class="nx">textArea</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">TextArea</span><span class="p">{}</span>
<a id="__codelineno-4-36" name="__codelineno-4-36"></a><a href="#__codelineno-4-36"><span class="linenos" data-linenos="36 "></span></a><span class="w">    </span><span class="nx">doc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">TextDocument</span><span class="p">{</span><span class="nx">textArea</span><span class="p">:</span><span class="w"> </span><span class="nx">textArea</span><span class="p">}</span>
<a id="__codelineno-4-37" name="__codelineno-4-37"></a><a href="#__codelineno-4-37"><span class="linenos" data-linenos="37 "></span></a>
<a id="__codelineno-4-38" name="__codelineno-4-38"></a><a href="#__codelineno-4-38"><span class="linenos" data-linenos="38 "></span></a><span class="w">    </span><span class="c1">// 客户端必须知道 TextDocument，而它只是透传</span>
<a id="__codelineno-4-39" name="__codelineno-4-39"></a><a href="#__codelineno-4-39"><span class="linenos" data-linenos="39 "></span></a><span class="w">    </span><span class="nx">doc</span><span class="p">.</span><span class="nx">InsertString</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-4-40" name="__codelineno-4-40"></a><a href="#__codelineno-4-40"><span class="linenos" data-linenos="40 "></span></a><span class="w">    </span><span class="nx">pos</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">doc</span><span class="p">.</span><span class="nx">GetCursorOffset</span><span class="p">()</span>
<a id="__codelineno-4-41" name="__codelineno-4-41"></a><a href="#__codelineno-4-41"><span class="linenos" data-linenos="41 "></span></a><span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-go highlight"><span class="filename">Go</span><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><a href="#__codelineno-5-1"><span class="linenos" data-linenos="1 "></span></a><span class="c1">// 直接让客户端使用 TextArea，去掉中间层</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><a href="#__codelineno-5-2"><span class="linenos" data-linenos="2 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><a href="#__codelineno-5-3"><span class="linenos" data-linenos="3 "></span></a><span class="w">    </span><span class="nx">textArea</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">TextArea</span><span class="p">{}</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><a href="#__codelineno-5-4"><span class="linenos" data-linenos="4 "></span></a>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><a href="#__codelineno-5-5"><span class="linenos" data-linenos="5 "></span></a><span class="w">    </span><span class="c1">// 直接使用底层类，避免不必要的中间层</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><a href="#__codelineno-5-6"><span class="linenos" data-linenos="6 "></span></a><span class="w">    </span><span class="nx">textArea</span><span class="p">.</span><span class="nx">InsertString</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><a href="#__codelineno-5-7"><span class="linenos" data-linenos="7 "></span></a><span class="w">    </span><span class="nx">pos</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">textArea</span><span class="p">.</span><span class="nx">GetCursorOffset</span><span class="p">()</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><a href="#__codelineno-5-8"><span class="linenos" data-linenos="8 "></span></a><span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-go highlight"><span class="filename">Go</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><a href="#__codelineno-6-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="c1">// TextArea 处理基本操作</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><a href="#__codelineno-6-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">TextArea</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><a href="#__codelineno-6-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">    </span><span class="nx">content</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><a href="#__codelineno-6-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">    </span><span class="nx">cursor</span><span class="w">  </span><span class="kt">int</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><a href="#__codelineno-6-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="p">}</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><a href="#__codelineno-6-6"><span class="linenos" data-linenos=" 6 "></span></a>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><a href="#__codelineno-6-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">TextArea</span><span class="p">)</span><span class="w"> </span><span class="nx">GetCursorOffset</span><span class="p">()</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><a href="#__codelineno-6-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">cursor</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a><a href="#__codelineno-6-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="p">}</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><a href="#__codelineno-6-10"><span class="linenos" data-linenos="10 "></span></a>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a><a href="#__codelineno-6-11"><span class="linenos" data-linenos="11 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">TextArea</span><span class="p">)</span><span class="w"> </span><span class="nx">InsertCharacters</span><span class="p">(</span><span class="nx">text</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a><a href="#__codelineno-6-12"><span class="linenos" data-linenos="12 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a><a href="#__codelineno-6-13"><span class="linenos" data-linenos="13 "></span></a><span class="w">        </span><span class="nx">t</span><span class="p">.</span><span class="nx">content</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">content</span><span class="p">[:</span><span class="nx">offset</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">content</span><span class="p">[</span><span class="nx">offset</span><span class="p">:]</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a><a href="#__codelineno-6-14"><span class="linenos" data-linenos="14 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a><a href="#__codelineno-6-15"><span class="linenos" data-linenos="15 "></span></a><span class="p">}</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a><a href="#__codelineno-6-16"><span class="linenos" data-linenos="16 "></span></a>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a><a href="#__codelineno-6-17"><span class="linenos" data-linenos="17 "></span></a><span class="c1">// TextDocument 提供更高级的文档操作</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a><a href="#__codelineno-6-18"><span class="linenos" data-linenos="18 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">TextDocument</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a><a href="#__codelineno-6-19"><span class="linenos" data-linenos="19 "></span></a><span class="w">    </span><span class="nx">textArea</span><span class="w"> </span><span class="o">*</span><span class="nx">TextArea</span>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a><a href="#__codelineno-6-20"><span class="linenos" data-linenos="20 "></span></a><span class="w">    </span><span class="nx">history</span><span class="w">  </span><span class="p">[]</span><span class="kt">string</span><span class="w"> </span><span class="c1">// 增加了撤销功能</span>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a><a href="#__codelineno-6-21"><span class="linenos" data-linenos="21 "></span></a><span class="p">}</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a><a href="#__codelineno-6-22"><span class="linenos" data-linenos="22 "></span></a>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a><a href="#__codelineno-6-23"><span class="linenos" data-linenos="23 "></span></a><span class="c1">// 不再是透传方法，增加了撤销历史记录功能</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a><a href="#__codelineno-6-24"><span class="linenos" data-linenos="24 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">d</span><span class="w"> </span><span class="o">*</span><span class="nx">TextDocument</span><span class="p">)</span><span class="w"> </span><span class="nx">InsertString</span><span class="p">(</span><span class="nx">text</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a><a href="#__codelineno-6-25"><span class="linenos" data-linenos="25 "></span></a><span class="w">    </span><span class="c1">// 保存当前状态用于撤销</span>
<a id="__codelineno-6-26" name="__codelineno-6-26"></a><a href="#__codelineno-6-26"><span class="linenos" data-linenos="26 "></span></a><span class="w">    </span><span class="nx">d</span><span class="p">.</span><span class="nx">history</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">history</span><span class="p">,</span><span class="w"> </span><span class="nx">d</span><span class="p">.</span><span class="nx">textArea</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
<a id="__codelineno-6-27" name="__codelineno-6-27"></a><a href="#__codelineno-6-27"><span class="linenos" data-linenos="27 "></span></a>
<a id="__codelineno-6-28" name="__codelineno-6-28"></a><a href="#__codelineno-6-28"><span class="linenos" data-linenos="28 "></span></a><span class="w">    </span><span class="c1">// 调用底层功能，但增加了价值</span>
<a id="__codelineno-6-29" name="__codelineno-6-29"></a><a href="#__codelineno-6-29"><span class="linenos" data-linenos="29 "></span></a><span class="w">    </span><span class="nx">d</span><span class="p">.</span><span class="nx">textArea</span><span class="p">.</span><span class="nx">InsertCharacters</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="p">)</span>
<a id="__codelineno-6-30" name="__codelineno-6-30"></a><a href="#__codelineno-6-30"><span class="linenos" data-linenos="30 "></span></a><span class="p">}</span>
<a id="__codelineno-6-31" name="__codelineno-6-31"></a><a href="#__codelineno-6-31"><span class="linenos" data-linenos="31 "></span></a>
<a id="__codelineno-6-32" name="__codelineno-6-32"></a><a href="#__codelineno-6-32"><span class="linenos" data-linenos="32 "></span></a><span class="c1">// 新增高级功能</span>
<a id="__codelineno-6-33" name="__codelineno-6-33"></a><a href="#__codelineno-6-33"><span class="linenos" data-linenos="33 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">d</span><span class="w"> </span><span class="o">*</span><span class="nx">TextDocument</span><span class="p">)</span><span class="w"> </span><span class="nx">Undo</span><span class="p">()</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-34" name="__codelineno-6-34"></a><a href="#__codelineno-6-34"><span class="linenos" data-linenos="34 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">history</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-35" name="__codelineno-6-35"></a><a href="#__codelineno-6-35"><span class="linenos" data-linenos="35 "></span></a><span class="w">        </span><span class="nx">lastIdx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">history</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-6-36" name="__codelineno-6-36"></a><a href="#__codelineno-6-36"><span class="linenos" data-linenos="36 "></span></a><span class="w">        </span><span class="nx">d</span><span class="p">.</span><span class="nx">textArea</span><span class="p">.</span><span class="nx">content</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">d</span><span class="p">.</span><span class="nx">history</span><span class="p">[</span><span class="nx">lastIdx</span><span class="p">]</span>
<a id="__codelineno-6-37" name="__codelineno-6-37"></a><a href="#__codelineno-6-37"><span class="linenos" data-linenos="37 "></span></a><span class="w">        </span><span class="nx">d</span><span class="p">.</span><span class="nx">history</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">d</span><span class="p">.</span><span class="nx">history</span><span class="p">[:</span><span class="nx">lastIdx</span><span class="p">]</span>
<a id="__codelineno-6-38" name="__codelineno-6-38"></a><a href="#__codelineno-6-38"><span class="linenos" data-linenos="38 "></span></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<a id="__codelineno-6-39" name="__codelineno-6-39"></a><a href="#__codelineno-6-39"><span class="linenos" data-linenos="39 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-40" name="__codelineno-6-40"></a><a href="#__codelineno-6-40"><span class="linenos" data-linenos="40 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<a id="__codelineno-6-41" name="__codelineno-6-41"></a><a href="#__codelineno-6-41"><span class="linenos" data-linenos="41 "></span></a><span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-go highlight"><span class="filename">Go</span><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><a href="#__codelineno-7-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="c1">// 合并 TextArea 和 TextDocument 的功能</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><a href="#__codelineno-7-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">TextEditor</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><a href="#__codelineno-7-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">    </span><span class="nx">content</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><a href="#__codelineno-7-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">    </span><span class="nx">cursor</span><span class="w">  </span><span class="kt">int</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><a href="#__codelineno-7-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="w">    </span><span class="nx">history</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><a href="#__codelineno-7-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="p">}</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><a href="#__codelineno-7-7"><span class="linenos" data-linenos=" 7 "></span></a>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><a href="#__codelineno-7-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">*</span><span class="nx">TextEditor</span><span class="p">)</span><span class="w"> </span><span class="nx">GetCursorOffset</span><span class="p">()</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><a href="#__codelineno-7-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">cursor</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><a href="#__codelineno-7-10"><span class="linenos" data-linenos="10 "></span></a><span class="p">}</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a><a href="#__codelineno-7-11"><span class="linenos" data-linenos="11 "></span></a>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><a href="#__codelineno-7-12"><span class="linenos" data-linenos="12 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">*</span><span class="nx">TextEditor</span><span class="p">)</span><span class="w"> </span><span class="nx">InsertString</span><span class="p">(</span><span class="nx">text</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><a href="#__codelineno-7-13"><span class="linenos" data-linenos="13 "></span></a><span class="w">    </span><span class="c1">// 保存历史用于撤销</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><a href="#__codelineno-7-14"><span class="linenos" data-linenos="14 "></span></a><span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">history</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">history</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a><a href="#__codelineno-7-15"><span class="linenos" data-linenos="15 "></span></a>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a><a href="#__codelineno-7-16"><span class="linenos" data-linenos="16 "></span></a><span class="w">    </span><span class="c1">// 执行插入</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a><a href="#__codelineno-7-17"><span class="linenos" data-linenos="17 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><a href="#__codelineno-7-18"><span class="linenos" data-linenos="18 "></span></a><span class="w">        </span><span class="nx">e</span><span class="p">.</span><span class="nx">content</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">content</span><span class="p">[:</span><span class="nx">offset</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">content</span><span class="p">[</span><span class="nx">offset</span><span class="p">:]</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a><a href="#__codelineno-7-19"><span class="linenos" data-linenos="19 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a><a href="#__codelineno-7-20"><span class="linenos" data-linenos="20 "></span></a><span class="p">}</span>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a><a href="#__codelineno-7-21"><span class="linenos" data-linenos="21 "></span></a>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a><a href="#__codelineno-7-22"><span class="linenos" data-linenos="22 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">*</span><span class="nx">TextEditor</span><span class="p">)</span><span class="w"> </span><span class="nx">Undo</span><span class="p">()</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a><a href="#__codelineno-7-23"><span class="linenos" data-linenos="23 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">history</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a><a href="#__codelineno-7-24"><span class="linenos" data-linenos="24 "></span></a><span class="w">        </span><span class="nx">lastIdx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">history</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a><a href="#__codelineno-7-25"><span class="linenos" data-linenos="25 "></span></a><span class="w">        </span><span class="nx">e</span><span class="p">.</span><span class="nx">content</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">history</span><span class="p">[</span><span class="nx">lastIdx</span><span class="p">]</span>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a><a href="#__codelineno-7-26"><span class="linenos" data-linenos="26 "></span></a><span class="w">        </span><span class="nx">e</span><span class="p">.</span><span class="nx">history</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">history</span><span class="p">[:</span><span class="nx">lastIdx</span><span class="p">]</span>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a><a href="#__codelineno-7-27"><span class="linenos" data-linenos="27 "></span></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<a id="__codelineno-7-28" name="__codelineno-7-28"></a><a href="#__codelineno-7-28"><span class="linenos" data-linenos="28 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-29" name="__codelineno-7-29"></a><a href="#__codelineno-7-29"><span class="linenos" data-linenos="29 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<a id="__codelineno-7-30" name="__codelineno-7-30"></a><a href="#__codelineno-7-30"><span class="linenos" data-linenos="30 "></span></a><span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p><strong>3.2 处理透传变量</strong></p>
<p><img alt="" src="https://img.zhengyua.cn/blog/202503120958913.png" /></p>
<p>可采用以下几种方式：</p>
<ul>
<li>
<p><strong>利用共享对象</strong>：如果顶层和底层方法已共享某对象，可将信息存储在该对象中</p>
</li>
<li>
<p><strong>使用全局变量</strong>：避免方法间传递，但会导致其他问题</p>
</li>
<li>
<p><strong>引入上下文对象（推荐）</strong>：</p>
<ul>
<li>创建专门存储所有系统全局状态的上下文对象</li>
<li>在主要对象中保存对上下文的引用</li>
<li>只在构造函数中显式传递上下文</li>
</ul>
</li>
</ul>
<div class="tabbed-set tabbed-alternate" data-tabs="2:3"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><input id="__tabbed_2_3" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">问题示例</label><label for="__tabbed_2_2">优化:利用共享变量</label><label for="__tabbed_2_3">优化:引入上下文对象(推荐)</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-go highlight"><span class="filename">Go</span><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><a href="#__codelineno-8-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="c1">// 配置类型</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><a href="#__codelineno-8-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">CertificateConfig</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><a href="#__codelineno-8-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">    </span><span class="nx">CertPath</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><a href="#__codelineno-8-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">    </span><span class="nx">KeyPath</span><span class="w">  </span><span class="kt">string</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><a href="#__codelineno-8-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="p">}</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><a href="#__codelineno-8-6"><span class="linenos" data-linenos=" 6 "></span></a>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><a href="#__codelineno-8-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="c1">// 最顶层方法</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><a href="#__codelineno-8-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><a href="#__codelineno-8-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="w">    </span><span class="c1">// 从命令行获取证书配置</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><a href="#__codelineno-8-10"><span class="linenos" data-linenos="10 "></span></a><span class="w">    </span><span class="nx">certConfig</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">CertificateConfig</span><span class="p">{</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a><a href="#__codelineno-8-11"><span class="linenos" data-linenos="11 "></span></a><span class="w">        </span><span class="nx">CertPath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/path/to/cert.pem&quot;</span><span class="p">,</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a><a href="#__codelineno-8-12"><span class="linenos" data-linenos="12 "></span></a><span class="w">        </span><span class="nx">KeyPath</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;/path/to/key.pem&quot;</span><span class="p">,</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a><a href="#__codelineno-8-13"><span class="linenos" data-linenos="13 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a><a href="#__codelineno-8-14"><span class="linenos" data-linenos="14 "></span></a>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a><a href="#__codelineno-8-15"><span class="linenos" data-linenos="15 "></span></a><span class="w">    </span><span class="c1">// certConfig 作为透传变量，通过整个调用链传递</span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a><a href="#__codelineno-8-16"><span class="linenos" data-linenos="16 "></span></a><span class="w">    </span><span class="nx">startServer</span><span class="p">(</span><span class="nx">certConfig</span><span class="p">)</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a><a href="#__codelineno-8-17"><span class="linenos" data-linenos="17 "></span></a><span class="p">}</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a><a href="#__codelineno-8-18"><span class="linenos" data-linenos="18 "></span></a>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a><a href="#__codelineno-8-19"><span class="linenos" data-linenos="19 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">startServer</span><span class="p">(</span><span class="nx">certConfig</span><span class="w"> </span><span class="nx">CertificateConfig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a><a href="#__codelineno-8-20"><span class="linenos" data-linenos="20 "></span></a><span class="w">    </span><span class="c1">// 并不使用 certConfig，只是传递</span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a><a href="#__codelineno-8-21"><span class="linenos" data-linenos="21 "></span></a><span class="w">    </span><span class="nx">initializeServer</span><span class="p">(</span><span class="nx">certConfig</span><span class="p">)</span>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a><a href="#__codelineno-8-22"><span class="linenos" data-linenos="22 "></span></a><span class="p">}</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a><a href="#__codelineno-8-23"><span class="linenos" data-linenos="23 "></span></a>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a><a href="#__codelineno-8-24"><span class="linenos" data-linenos="24 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">initializeServer</span><span class="p">(</span><span class="nx">certConfig</span><span class="w"> </span><span class="nx">CertificateConfig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a><a href="#__codelineno-8-25"><span class="linenos" data-linenos="25 "></span></a><span class="w">    </span><span class="c1">// 并不使用 certConfig，只是传递</span>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a><a href="#__codelineno-8-26"><span class="linenos" data-linenos="26 "></span></a><span class="w">    </span><span class="nx">setupConnections</span><span class="p">(</span><span class="nx">certConfig</span><span class="p">)</span>
<a id="__codelineno-8-27" name="__codelineno-8-27"></a><a href="#__codelineno-8-27"><span class="linenos" data-linenos="27 "></span></a><span class="p">}</span>
<a id="__codelineno-8-28" name="__codelineno-8-28"></a><a href="#__codelineno-8-28"><span class="linenos" data-linenos="28 "></span></a>
<a id="__codelineno-8-29" name="__codelineno-8-29"></a><a href="#__codelineno-8-29"><span class="linenos" data-linenos="29 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">setupConnections</span><span class="p">(</span><span class="nx">certConfig</span><span class="w"> </span><span class="nx">CertificateConfig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-30" name="__codelineno-8-30"></a><a href="#__codelineno-8-30"><span class="linenos" data-linenos="30 "></span></a><span class="w">    </span><span class="c1">// 最终在这里使用 certConfig</span>
<a id="__codelineno-8-31" name="__codelineno-8-31"></a><a href="#__codelineno-8-31"><span class="linenos" data-linenos="31 "></span></a><span class="w">    </span><span class="nx">openSecureSocket</span><span class="p">(</span><span class="nx">certConfig</span><span class="p">)</span>
<a id="__codelineno-8-32" name="__codelineno-8-32"></a><a href="#__codelineno-8-32"><span class="linenos" data-linenos="32 "></span></a><span class="p">}</span>
<a id="__codelineno-8-33" name="__codelineno-8-33"></a><a href="#__codelineno-8-33"><span class="linenos" data-linenos="33 "></span></a>
<a id="__codelineno-8-34" name="__codelineno-8-34"></a><a href="#__codelineno-8-34"><span class="linenos" data-linenos="34 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">openSecureSocket</span><span class="p">(</span><span class="nx">certConfig</span><span class="w"> </span><span class="nx">CertificateConfig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-35" name="__codelineno-8-35"></a><a href="#__codelineno-8-35"><span class="linenos" data-linenos="35 "></span></a><span class="w">    </span><span class="c1">// 这里才真正使用证书配置</span>
<a id="__codelineno-8-36" name="__codelineno-8-36"></a><a href="#__codelineno-8-36"><span class="linenos" data-linenos="36 "></span></a><span class="w">    </span><span class="nb">println</span><span class="p">(</span><span class="s">&quot;Opening secure socket with cert:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">certConfig</span><span class="p">.</span><span class="nx">CertPath</span><span class="p">)</span>
<a id="__codelineno-8-37" name="__codelineno-8-37"></a><a href="#__codelineno-8-37"><span class="linenos" data-linenos="37 "></span></a><span class="w">    </span><span class="nb">println</span><span class="p">(</span><span class="s">&quot;and key:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">certConfig</span><span class="p">.</span><span class="nx">KeyPath</span><span class="p">)</span>
<a id="__codelineno-8-38" name="__codelineno-8-38"></a><a href="#__codelineno-8-38"><span class="linenos" data-linenos="38 "></span></a><span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-go highlight"><span class="filename">Go</span><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><a href="#__codelineno-9-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="c1">// 服务器上下文对象</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><a href="#__codelineno-9-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">ServerContext</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><a href="#__codelineno-9-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">    </span><span class="nx">CertConfig</span><span class="w"> </span><span class="nx">CertificateConfig</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><a href="#__codelineno-9-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">    </span><span class="c1">// 其他配置...</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><a href="#__codelineno-9-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="p">}</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><a href="#__codelineno-9-6"><span class="linenos" data-linenos=" 6 "></span></a>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><a href="#__codelineno-9-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><a href="#__codelineno-9-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="w">    </span><span class="c1">// 创建共享的上下文对象</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a><a href="#__codelineno-9-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ServerContext</span><span class="p">{</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><a href="#__codelineno-9-10"><span class="linenos" data-linenos="10 "></span></a><span class="w">        </span><span class="nx">CertConfig</span><span class="p">:</span><span class="w"> </span><span class="nx">CertificateConfig</span><span class="p">{</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a><a href="#__codelineno-9-11"><span class="linenos" data-linenos="11 "></span></a><span class="w">            </span><span class="nx">CertPath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/path/to/cert.pem&quot;</span><span class="p">,</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a><a href="#__codelineno-9-12"><span class="linenos" data-linenos="12 "></span></a><span class="w">            </span><span class="nx">KeyPath</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;/path/to/key.pem&quot;</span><span class="p">,</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a><a href="#__codelineno-9-13"><span class="linenos" data-linenos="13 "></span></a><span class="w">        </span><span class="p">},</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a><a href="#__codelineno-9-14"><span class="linenos" data-linenos="14 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a><a href="#__codelineno-9-15"><span class="linenos" data-linenos="15 "></span></a>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a><a href="#__codelineno-9-16"><span class="linenos" data-linenos="16 "></span></a><span class="w">    </span><span class="c1">// 只传递上下文</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a><a href="#__codelineno-9-17"><span class="linenos" data-linenos="17 "></span></a><span class="w">    </span><span class="nx">startServer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a><a href="#__codelineno-9-18"><span class="linenos" data-linenos="18 "></span></a><span class="p">}</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a><a href="#__codelineno-9-19"><span class="linenos" data-linenos="19 "></span></a>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a><a href="#__codelineno-9-20"><span class="linenos" data-linenos="20 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">startServer</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">ServerContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-21" name="__codelineno-9-21"></a><a href="#__codelineno-9-21"><span class="linenos" data-linenos="21 "></span></a><span class="w">    </span><span class="nx">initializeServer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<a id="__codelineno-9-22" name="__codelineno-9-22"></a><a href="#__codelineno-9-22"><span class="linenos" data-linenos="22 "></span></a><span class="p">}</span>
<a id="__codelineno-9-23" name="__codelineno-9-23"></a><a href="#__codelineno-9-23"><span class="linenos" data-linenos="23 "></span></a>
<a id="__codelineno-9-24" name="__codelineno-9-24"></a><a href="#__codelineno-9-24"><span class="linenos" data-linenos="24 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">initializeServer</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">ServerContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-25" name="__codelineno-9-25"></a><a href="#__codelineno-9-25"><span class="linenos" data-linenos="25 "></span></a><span class="w">    </span><span class="nx">setupConnections</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<a id="__codelineno-9-26" name="__codelineno-9-26"></a><a href="#__codelineno-9-26"><span class="linenos" data-linenos="26 "></span></a><span class="p">}</span>
<a id="__codelineno-9-27" name="__codelineno-9-27"></a><a href="#__codelineno-9-27"><span class="linenos" data-linenos="27 "></span></a>
<a id="__codelineno-9-28" name="__codelineno-9-28"></a><a href="#__codelineno-9-28"><span class="linenos" data-linenos="28 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">setupConnections</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">ServerContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-29" name="__codelineno-9-29"></a><a href="#__codelineno-9-29"><span class="linenos" data-linenos="29 "></span></a><span class="w">    </span><span class="nx">openSecureSocket</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">CertConfig</span><span class="p">)</span>
<a id="__codelineno-9-30" name="__codelineno-9-30"></a><a href="#__codelineno-9-30"><span class="linenos" data-linenos="30 "></span></a><span class="p">}</span>
<a id="__codelineno-9-31" name="__codelineno-9-31"></a><a href="#__codelineno-9-31"><span class="linenos" data-linenos="31 "></span></a>
<a id="__codelineno-9-32" name="__codelineno-9-32"></a><a href="#__codelineno-9-32"><span class="linenos" data-linenos="32 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">openSecureSocket</span><span class="p">(</span><span class="nx">certConfig</span><span class="w"> </span><span class="nx">CertificateConfig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-33" name="__codelineno-9-33"></a><a href="#__codelineno-9-33"><span class="linenos" data-linenos="33 "></span></a><span class="w">    </span><span class="nb">println</span><span class="p">(</span><span class="s">&quot;Opening secure socket with cert:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">certConfig</span><span class="p">.</span><span class="nx">CertPath</span><span class="p">)</span>
<a id="__codelineno-9-34" name="__codelineno-9-34"></a><a href="#__codelineno-9-34"><span class="linenos" data-linenos="34 "></span></a><span class="w">    </span><span class="nb">println</span><span class="p">(</span><span class="s">&quot;and key:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">certConfig</span><span class="p">.</span><span class="nx">KeyPath</span><span class="p">)</span>
<a id="__codelineno-9-35" name="__codelineno-9-35"></a><a href="#__codelineno-9-35"><span class="linenos" data-linenos="35 "></span></a><span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-go highlight"><span class="filename">Go</span><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><a href="#__codelineno-10-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="c1">// 上下文对象</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><a href="#__codelineno-10-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">AppContext</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><a href="#__codelineno-10-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">    </span><span class="nx">CertConfig</span><span class="w">    </span><span class="nx">CertificateConfig</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><a href="#__codelineno-10-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">    </span><span class="nx">Timeout</span><span class="w">       </span><span class="kt">int</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a><a href="#__codelineno-10-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="w">    </span><span class="nx">PerformanceCounter</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a><a href="#__codelineno-10-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="w">    </span><span class="c1">// 其他全局状态...</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a><a href="#__codelineno-10-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="p">}</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a><a href="#__codelineno-10-8"><span class="linenos" data-linenos=" 8 "></span></a>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a><a href="#__codelineno-10-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="c1">// 服务器类，存储对上下文的引用</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a><a href="#__codelineno-10-10"><span class="linenos" data-linenos="10 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">Server</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a><a href="#__codelineno-10-11"><span class="linenos" data-linenos="11 "></span></a><span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="o">*</span><span class="nx">AppContext</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a><a href="#__codelineno-10-12"><span class="linenos" data-linenos="12 "></span></a><span class="p">}</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a><a href="#__codelineno-10-13"><span class="linenos" data-linenos="13 "></span></a>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a><a href="#__codelineno-10-14"><span class="linenos" data-linenos="14 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewServer</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="o">*</span><span class="nx">AppContext</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a><a href="#__codelineno-10-15"><span class="linenos" data-linenos="15 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">Server</span><span class="p">{</span><span class="nx">ctx</span><span class="p">:</span><span class="w"> </span><span class="nx">ctx</span><span class="p">}</span>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a><a href="#__codelineno-10-16"><span class="linenos" data-linenos="16 "></span></a><span class="p">}</span>
<a id="__codelineno-10-17" name="__codelineno-10-17"></a><a href="#__codelineno-10-17"><span class="linenos" data-linenos="17 "></span></a>
<a id="__codelineno-10-18" name="__codelineno-10-18"></a><a href="#__codelineno-10-18"><span class="linenos" data-linenos="18 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">Start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-19" name="__codelineno-10-19"></a><a href="#__codelineno-10-19"><span class="linenos" data-linenos="19 "></span></a><span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">initialize</span><span class="p">()</span>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a><a href="#__codelineno-10-20"><span class="linenos" data-linenos="20 "></span></a><span class="p">}</span>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a><a href="#__codelineno-10-21"><span class="linenos" data-linenos="21 "></span></a>
<a id="__codelineno-10-22" name="__codelineno-10-22"></a><a href="#__codelineno-10-22"><span class="linenos" data-linenos="22 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">initialize</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-23" name="__codelineno-10-23"></a><a href="#__codelineno-10-23"><span class="linenos" data-linenos="23 "></span></a><span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">setupConnections</span><span class="p">()</span>
<a id="__codelineno-10-24" name="__codelineno-10-24"></a><a href="#__codelineno-10-24"><span class="linenos" data-linenos="24 "></span></a><span class="p">}</span>
<a id="__codelineno-10-25" name="__codelineno-10-25"></a><a href="#__codelineno-10-25"><span class="linenos" data-linenos="25 "></span></a>
<a id="__codelineno-10-26" name="__codelineno-10-26"></a><a href="#__codelineno-10-26"><span class="linenos" data-linenos="26 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">setupConnections</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-27" name="__codelineno-10-27"></a><a href="#__codelineno-10-27"><span class="linenos" data-linenos="27 "></span></a><span class="w">    </span><span class="c1">// 直接从存储的上下文获取配置，不需要透传</span>
<a id="__codelineno-10-28" name="__codelineno-10-28"></a><a href="#__codelineno-10-28"><span class="linenos" data-linenos="28 "></span></a><span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">openSecureSocket</span><span class="p">()</span>
<a id="__codelineno-10-29" name="__codelineno-10-29"></a><a href="#__codelineno-10-29"><span class="linenos" data-linenos="29 "></span></a><span class="p">}</span>
<a id="__codelineno-10-30" name="__codelineno-10-30"></a><a href="#__codelineno-10-30"><span class="linenos" data-linenos="30 "></span></a>
<a id="__codelineno-10-31" name="__codelineno-10-31"></a><a href="#__codelineno-10-31"><span class="linenos" data-linenos="31 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">openSecureSocket</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-32" name="__codelineno-10-32"></a><a href="#__codelineno-10-32"><span class="linenos" data-linenos="32 "></span></a><span class="w">    </span><span class="c1">// 直接访问上下文中的证书配置</span>
<a id="__codelineno-10-33" name="__codelineno-10-33"></a><a href="#__codelineno-10-33"><span class="linenos" data-linenos="33 "></span></a><span class="w">    </span><span class="nx">certConfig</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">CertConfig</span>
<a id="__codelineno-10-34" name="__codelineno-10-34"></a><a href="#__codelineno-10-34"><span class="linenos" data-linenos="34 "></span></a><span class="w">    </span><span class="nb">println</span><span class="p">(</span><span class="s">&quot;Opening secure socket with cert:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">certConfig</span><span class="p">.</span><span class="nx">CertPath</span><span class="p">)</span>
<a id="__codelineno-10-35" name="__codelineno-10-35"></a><a href="#__codelineno-10-35"><span class="linenos" data-linenos="35 "></span></a><span class="w">    </span><span class="nb">println</span><span class="p">(</span><span class="s">&quot;and key:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">certConfig</span><span class="p">.</span><span class="nx">KeyPath</span><span class="p">)</span>
<a id="__codelineno-10-36" name="__codelineno-10-36"></a><a href="#__codelineno-10-36"><span class="linenos" data-linenos="36 "></span></a><span class="p">}</span>
<a id="__codelineno-10-37" name="__codelineno-10-37"></a><a href="#__codelineno-10-37"><span class="linenos" data-linenos="37 "></span></a>
<a id="__codelineno-10-38" name="__codelineno-10-38"></a><a href="#__codelineno-10-38"><span class="linenos" data-linenos="38 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-39" name="__codelineno-10-39"></a><a href="#__codelineno-10-39"><span class="linenos" data-linenos="39 "></span></a><span class="w">    </span><span class="c1">// 创建应用上下文</span>
<a id="__codelineno-10-40" name="__codelineno-10-40"></a><a href="#__codelineno-10-40"><span class="linenos" data-linenos="40 "></span></a><span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">AppContext</span><span class="p">{</span>
<a id="__codelineno-10-41" name="__codelineno-10-41"></a><a href="#__codelineno-10-41"><span class="linenos" data-linenos="41 "></span></a><span class="w">        </span><span class="nx">CertConfig</span><span class="p">:</span><span class="w"> </span><span class="nx">CertificateConfig</span><span class="p">{</span>
<a id="__codelineno-10-42" name="__codelineno-10-42"></a><a href="#__codelineno-10-42"><span class="linenos" data-linenos="42 "></span></a><span class="w">            </span><span class="nx">CertPath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/path/to/cert.pem&quot;</span><span class="p">,</span>
<a id="__codelineno-10-43" name="__codelineno-10-43"></a><a href="#__codelineno-10-43"><span class="linenos" data-linenos="43 "></span></a><span class="w">            </span><span class="nx">KeyPath</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;/path/to/key.pem&quot;</span><span class="p">,</span>
<a id="__codelineno-10-44" name="__codelineno-10-44"></a><a href="#__codelineno-10-44"><span class="linenos" data-linenos="44 "></span></a><span class="w">        </span><span class="p">},</span>
<a id="__codelineno-10-45" name="__codelineno-10-45"></a><a href="#__codelineno-10-45"><span class="linenos" data-linenos="45 "></span></a><span class="w">        </span><span class="nx">Timeout</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span>
<a id="__codelineno-10-46" name="__codelineno-10-46"></a><a href="#__codelineno-10-46"><span class="linenos" data-linenos="46 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-47" name="__codelineno-10-47"></a><a href="#__codelineno-10-47"><span class="linenos" data-linenos="47 "></span></a>
<a id="__codelineno-10-48" name="__codelineno-10-48"></a><a href="#__codelineno-10-48"><span class="linenos" data-linenos="48 "></span></a><span class="w">    </span><span class="c1">// 创建服务器并启动</span>
<a id="__codelineno-10-49" name="__codelineno-10-49"></a><a href="#__codelineno-10-49"><span class="linenos" data-linenos="49 "></span></a><span class="w">    </span><span class="nx">server</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewServer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<a id="__codelineno-10-50" name="__codelineno-10-50"></a><a href="#__codelineno-10-50"><span class="linenos" data-linenos="50 "></span></a><span class="w">    </span><span class="nx">server</span><span class="p">.</span><span class="nx">Start</span><span class="p">()</span>
<a id="__codelineno-10-51" name="__codelineno-10-51"></a><a href="#__codelineno-10-51"><span class="linenos" data-linenos="51 "></span></a><span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p><strong>4. 特殊情况：何时接口重复是可接受的</strong></p>
<p>不是所有相同签名的方法都有问题。<strong>关键在于每个新方法是否提供重要的新功能</strong>：</p>
<ul>
<li><strong>调度器（Dispatcher）</strong>：虽然签名相同，但负责根据参数选择合适的方法执行任务</li>
<li><strong>多重实现的接口</strong>：如操作系统中的磁盘驱动程序，针对不同设备提供相同接口</li>
</ul>
<p><strong>5. 装饰器模式的注意事项</strong></p>
<p>装饰器模式（Decorator）会<strong>导致API跨层重复</strong>：</p>
<ul>
<li>特点：提供与底层对象相同或相似的API，同时扩展其功能</li>
<li>问题：装饰器类通常很浅，为了实现少量新功能引入大量样板代码</li>
<li>替代方案：<ol>
<li>直接将新功能添加到底层类</li>
<li>将特定用例功能与用例合并</li>
<li>与现有装饰器合并</li>
<li>实现为独立的非包装类</li>
</ol>
</li>
</ul>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">问题示例</label><label for="__tabbed_3_2">更好的设计：整合功能，避免多层装饰</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-go highlight"><span class="filename">Go</span><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><a href="#__codelineno-11-1"><span class="linenos" data-linenos="  1 "></span></a><span class="c1">// 基本窗口接口</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><a href="#__codelineno-11-2"><span class="linenos" data-linenos="  2 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">Window</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><a href="#__codelineno-11-3"><span class="linenos" data-linenos="  3 "></span></a><span class="w">    </span><span class="nx">Draw</span><span class="p">()</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><a href="#__codelineno-11-4"><span class="linenos" data-linenos="  4 "></span></a><span class="w">    </span><span class="nx">GetWidth</span><span class="p">()</span><span class="w"> </span><span class="kt">int</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a><a href="#__codelineno-11-5"><span class="linenos" data-linenos="  5 "></span></a><span class="w">    </span><span class="nx">GetHeight</span><span class="p">()</span><span class="w"> </span><span class="kt">int</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a><a href="#__codelineno-11-6"><span class="linenos" data-linenos="  6 "></span></a><span class="w">    </span><span class="nx">HandleClick</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a><a href="#__codelineno-11-7"><span class="linenos" data-linenos="  7 "></span></a><span class="p">}</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><a href="#__codelineno-11-8"><span class="linenos" data-linenos="  8 "></span></a>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a><a href="#__codelineno-11-9"><span class="linenos" data-linenos="  9 "></span></a><span class="c1">// 基本窗口实现</span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a><a href="#__codelineno-11-10"><span class="linenos" data-linenos=" 10 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">BasicWindow</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a><a href="#__codelineno-11-11"><span class="linenos" data-linenos=" 11 "></span></a><span class="w">    </span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="w"> </span><span class="kt">int</span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a><a href="#__codelineno-11-12"><span class="linenos" data-linenos=" 12 "></span></a><span class="w">    </span><span class="nx">content</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a><a href="#__codelineno-11-13"><span class="linenos" data-linenos=" 13 "></span></a><span class="p">}</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a><a href="#__codelineno-11-14"><span class="linenos" data-linenos=" 14 "></span></a>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a><a href="#__codelineno-11-15"><span class="linenos" data-linenos=" 15 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="nx">BasicWindow</span><span class="p">)</span><span class="w"> </span><span class="nx">Draw</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a><a href="#__codelineno-11-16"><span class="linenos" data-linenos=" 16 "></span></a><span class="w">    </span><span class="nb">println</span><span class="p">(</span><span class="s">&quot;Drawing window with content:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a><a href="#__codelineno-11-17"><span class="linenos" data-linenos=" 17 "></span></a><span class="p">}</span>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a><a href="#__codelineno-11-18"><span class="linenos" data-linenos=" 18 "></span></a>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a><a href="#__codelineno-11-19"><span class="linenos" data-linenos=" 19 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="nx">BasicWindow</span><span class="p">)</span><span class="w"> </span><span class="nx">GetWidth</span><span class="p">()</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a><a href="#__codelineno-11-20"><span class="linenos" data-linenos=" 20 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">width</span>
<a id="__codelineno-11-21" name="__codelineno-11-21"></a><a href="#__codelineno-11-21"><span class="linenos" data-linenos=" 21 "></span></a><span class="p">}</span>
<a id="__codelineno-11-22" name="__codelineno-11-22"></a><a href="#__codelineno-11-22"><span class="linenos" data-linenos=" 22 "></span></a>
<a id="__codelineno-11-23" name="__codelineno-11-23"></a><a href="#__codelineno-11-23"><span class="linenos" data-linenos=" 23 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="nx">BasicWindow</span><span class="p">)</span><span class="w"> </span><span class="nx">GetHeight</span><span class="p">()</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-24" name="__codelineno-11-24"></a><a href="#__codelineno-11-24"><span class="linenos" data-linenos=" 24 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">height</span>
<a id="__codelineno-11-25" name="__codelineno-11-25"></a><a href="#__codelineno-11-25"><span class="linenos" data-linenos=" 25 "></span></a><span class="p">}</span>
<a id="__codelineno-11-26" name="__codelineno-11-26"></a><a href="#__codelineno-11-26"><span class="linenos" data-linenos=" 26 "></span></a>
<a id="__codelineno-11-27" name="__codelineno-11-27"></a><a href="#__codelineno-11-27"><span class="linenos" data-linenos=" 27 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="nx">BasicWindow</span><span class="p">)</span><span class="w"> </span><span class="nx">HandleClick</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-28" name="__codelineno-11-28"></a><a href="#__codelineno-11-28"><span class="linenos" data-linenos=" 28 "></span></a><span class="w">    </span><span class="nb">println</span><span class="p">(</span><span class="s">&quot;Clicked at:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span>
<a id="__codelineno-11-29" name="__codelineno-11-29"></a><a href="#__codelineno-11-29"><span class="linenos" data-linenos=" 29 "></span></a><span class="p">}</span>
<a id="__codelineno-11-30" name="__codelineno-11-30"></a><a href="#__codelineno-11-30"><span class="linenos" data-linenos=" 30 "></span></a>
<a id="__codelineno-11-31" name="__codelineno-11-31"></a><a href="#__codelineno-11-31"><span class="linenos" data-linenos=" 31 "></span></a><span class="c1">// 装饰器：滚动窗口</span>
<a id="__codelineno-11-32" name="__codelineno-11-32"></a><a href="#__codelineno-11-32"><span class="linenos" data-linenos=" 32 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">ScrollableWindow</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-33" name="__codelineno-11-33"></a><a href="#__codelineno-11-33"><span class="linenos" data-linenos=" 33 "></span></a><span class="w">    </span><span class="nx">window</span><span class="w"> </span><span class="nx">Window</span><span class="w"> </span><span class="c1">// 包装的窗口</span>
<a id="__codelineno-11-34" name="__codelineno-11-34"></a><a href="#__codelineno-11-34"><span class="linenos" data-linenos=" 34 "></span></a><span class="w">    </span><span class="nx">scrollX</span><span class="p">,</span><span class="w"> </span><span class="nx">scrollY</span><span class="w"> </span><span class="kt">int</span>
<a id="__codelineno-11-35" name="__codelineno-11-35"></a><a href="#__codelineno-11-35"><span class="linenos" data-linenos=" 35 "></span></a><span class="p">}</span>
<a id="__codelineno-11-36" name="__codelineno-11-36"></a><a href="#__codelineno-11-36"><span class="linenos" data-linenos=" 36 "></span></a>
<a id="__codelineno-11-37" name="__codelineno-11-37"></a><a href="#__codelineno-11-37"><span class="linenos" data-linenos=" 37 "></span></a><span class="c1">// 透传同时添加功能</span>
<a id="__codelineno-11-38" name="__codelineno-11-38"></a><a href="#__codelineno-11-38"><span class="linenos" data-linenos=" 38 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">ScrollableWindow</span><span class="p">)</span><span class="w"> </span><span class="nx">Draw</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-39" name="__codelineno-11-39"></a><a href="#__codelineno-11-39"><span class="linenos" data-linenos=" 39 "></span></a><span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">window</span><span class="p">.</span><span class="nx">Draw</span><span class="p">()</span>
<a id="__codelineno-11-40" name="__codelineno-11-40"></a><a href="#__codelineno-11-40"><span class="linenos" data-linenos=" 40 "></span></a><span class="w">    </span><span class="nb">println</span><span class="p">(</span><span class="s">&quot;Drawing scrollbars at position:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">scrollX</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">scrollY</span><span class="p">)</span>
<a id="__codelineno-11-41" name="__codelineno-11-41"></a><a href="#__codelineno-11-41"><span class="linenos" data-linenos=" 41 "></span></a><span class="p">}</span>
<a id="__codelineno-11-42" name="__codelineno-11-42"></a><a href="#__codelineno-11-42"><span class="linenos" data-linenos=" 42 "></span></a>
<a id="__codelineno-11-43" name="__codelineno-11-43"></a><a href="#__codelineno-11-43"><span class="linenos" data-linenos=" 43 "></span></a><span class="c1">// 透传方法</span>
<a id="__codelineno-11-44" name="__codelineno-11-44"></a><a href="#__codelineno-11-44"><span class="linenos" data-linenos=" 44 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">ScrollableWindow</span><span class="p">)</span><span class="w"> </span><span class="nx">GetWidth</span><span class="p">()</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-45" name="__codelineno-11-45"></a><a href="#__codelineno-11-45"><span class="linenos" data-linenos=" 45 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">window</span><span class="p">.</span><span class="nx">GetWidth</span><span class="p">()</span>
<a id="__codelineno-11-46" name="__codelineno-11-46"></a><a href="#__codelineno-11-46"><span class="linenos" data-linenos=" 46 "></span></a><span class="p">}</span>
<a id="__codelineno-11-47" name="__codelineno-11-47"></a><a href="#__codelineno-11-47"><span class="linenos" data-linenos=" 47 "></span></a>
<a id="__codelineno-11-48" name="__codelineno-11-48"></a><a href="#__codelineno-11-48"><span class="linenos" data-linenos=" 48 "></span></a><span class="c1">// 透传方法</span>
<a id="__codelineno-11-49" name="__codelineno-11-49"></a><a href="#__codelineno-11-49"><span class="linenos" data-linenos=" 49 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">ScrollableWindow</span><span class="p">)</span><span class="w"> </span><span class="nx">GetHeight</span><span class="p">()</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-50" name="__codelineno-11-50"></a><a href="#__codelineno-11-50"><span class="linenos" data-linenos=" 50 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">window</span><span class="p">.</span><span class="nx">GetHeight</span><span class="p">()</span>
<a id="__codelineno-11-51" name="__codelineno-11-51"></a><a href="#__codelineno-11-51"><span class="linenos" data-linenos=" 51 "></span></a><span class="p">}</span>
<a id="__codelineno-11-52" name="__codelineno-11-52"></a><a href="#__codelineno-11-52"><span class="linenos" data-linenos=" 52 "></span></a>
<a id="__codelineno-11-53" name="__codelineno-11-53"></a><a href="#__codelineno-11-53"><span class="linenos" data-linenos=" 53 "></span></a><span class="c1">// 透传同时添加功能</span>
<a id="__codelineno-11-54" name="__codelineno-11-54"></a><a href="#__codelineno-11-54"><span class="linenos" data-linenos=" 54 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">ScrollableWindow</span><span class="p">)</span><span class="w"> </span><span class="nx">HandleClick</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-55" name="__codelineno-11-55"></a><a href="#__codelineno-11-55"><span class="linenos" data-linenos=" 55 "></span></a><span class="w">    </span><span class="c1">// 检查是否点击了滚动条</span>
<a id="__codelineno-11-56" name="__codelineno-11-56"></a><a href="#__codelineno-11-56"><span class="linenos" data-linenos=" 56 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">isScrollbarClick</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-57" name="__codelineno-11-57"></a><a href="#__codelineno-11-57"><span class="linenos" data-linenos=" 57 "></span></a><span class="w">        </span><span class="nb">println</span><span class="p">(</span><span class="s">&quot;Adjusting scroll position&quot;</span><span class="p">)</span>
<a id="__codelineno-11-58" name="__codelineno-11-58"></a><a href="#__codelineno-11-58"><span class="linenos" data-linenos=" 58 "></span></a><span class="w">        </span><span class="k">return</span>
<a id="__codelineno-11-59" name="__codelineno-11-59"></a><a href="#__codelineno-11-59"><span class="linenos" data-linenos=" 59 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-60" name="__codelineno-11-60"></a><a href="#__codelineno-11-60"><span class="linenos" data-linenos=" 60 "></span></a><span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">window</span><span class="p">.</span><span class="nx">HandleClick</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span>
<a id="__codelineno-11-61" name="__codelineno-11-61"></a><a href="#__codelineno-11-61"><span class="linenos" data-linenos=" 61 "></span></a><span class="p">}</span>
<a id="__codelineno-11-62" name="__codelineno-11-62"></a><a href="#__codelineno-11-62"><span class="linenos" data-linenos=" 62 "></span></a>
<a id="__codelineno-11-63" name="__codelineno-11-63"></a><a href="#__codelineno-11-63"><span class="linenos" data-linenos=" 63 "></span></a><span class="c1">// 再增加一个装饰器：边框窗口</span>
<a id="__codelineno-11-64" name="__codelineno-11-64"></a><a href="#__codelineno-11-64"><span class="linenos" data-linenos=" 64 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">BorderedWindow</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-65" name="__codelineno-11-65"></a><a href="#__codelineno-11-65"><span class="linenos" data-linenos=" 65 "></span></a><span class="w">    </span><span class="nx">window</span><span class="w"> </span><span class="nx">Window</span>
<a id="__codelineno-11-66" name="__codelineno-11-66"></a><a href="#__codelineno-11-66"><span class="linenos" data-linenos=" 66 "></span></a><span class="w">    </span><span class="nx">borderWidth</span><span class="w"> </span><span class="kt">int</span>
<a id="__codelineno-11-67" name="__codelineno-11-67"></a><a href="#__codelineno-11-67"><span class="linenos" data-linenos=" 67 "></span></a><span class="p">}</span>
<a id="__codelineno-11-68" name="__codelineno-11-68"></a><a href="#__codelineno-11-68"><span class="linenos" data-linenos=" 68 "></span></a>
<a id="__codelineno-11-69" name="__codelineno-11-69"></a><a href="#__codelineno-11-69"><span class="linenos" data-linenos=" 69 "></span></a><span class="c1">// 透传同时添加功能</span>
<a id="__codelineno-11-70" name="__codelineno-11-70"></a><a href="#__codelineno-11-70"><span class="linenos" data-linenos=" 70 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">BorderedWindow</span><span class="p">)</span><span class="w"> </span><span class="nx">Draw</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-71" name="__codelineno-11-71"></a><a href="#__codelineno-11-71"><span class="linenos" data-linenos=" 71 "></span></a><span class="w">    </span><span class="nx">b</span><span class="p">.</span><span class="nx">window</span><span class="p">.</span><span class="nx">Draw</span><span class="p">()</span>
<a id="__codelineno-11-72" name="__codelineno-11-72"></a><a href="#__codelineno-11-72"><span class="linenos" data-linenos=" 72 "></span></a><span class="w">    </span><span class="nb">println</span><span class="p">(</span><span class="s">&quot;Drawing border with width:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">borderWidth</span><span class="p">)</span>
<a id="__codelineno-11-73" name="__codelineno-11-73"></a><a href="#__codelineno-11-73"><span class="linenos" data-linenos=" 73 "></span></a><span class="p">}</span>
<a id="__codelineno-11-74" name="__codelineno-11-74"></a><a href="#__codelineno-11-74"><span class="linenos" data-linenos=" 74 "></span></a>
<a id="__codelineno-11-75" name="__codelineno-11-75"></a><a href="#__codelineno-11-75"><span class="linenos" data-linenos=" 75 "></span></a><span class="c1">// 透传方法</span>
<a id="__codelineno-11-76" name="__codelineno-11-76"></a><a href="#__codelineno-11-76"><span class="linenos" data-linenos=" 76 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">BorderedWindow</span><span class="p">)</span><span class="w"> </span><span class="nx">GetWidth</span><span class="p">()</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-77" name="__codelineno-11-77"></a><a href="#__codelineno-11-77"><span class="linenos" data-linenos=" 77 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">window</span><span class="p">.</span><span class="nx">GetWidth</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">borderWidth</span>
<a id="__codelineno-11-78" name="__codelineno-11-78"></a><a href="#__codelineno-11-78"><span class="linenos" data-linenos=" 78 "></span></a><span class="p">}</span>
<a id="__codelineno-11-79" name="__codelineno-11-79"></a><a href="#__codelineno-11-79"><span class="linenos" data-linenos=" 79 "></span></a>
<a id="__codelineno-11-80" name="__codelineno-11-80"></a><a href="#__codelineno-11-80"><span class="linenos" data-linenos=" 80 "></span></a><span class="c1">// 透传方法</span>
<a id="__codelineno-11-81" name="__codelineno-11-81"></a><a href="#__codelineno-11-81"><span class="linenos" data-linenos=" 81 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">BorderedWindow</span><span class="p">)</span><span class="w"> </span><span class="nx">GetHeight</span><span class="p">()</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-82" name="__codelineno-11-82"></a><a href="#__codelineno-11-82"><span class="linenos" data-linenos=" 82 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">window</span><span class="p">.</span><span class="nx">GetHeight</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">borderWidth</span>
<a id="__codelineno-11-83" name="__codelineno-11-83"></a><a href="#__codelineno-11-83"><span class="linenos" data-linenos=" 83 "></span></a><span class="p">}</span>
<a id="__codelineno-11-84" name="__codelineno-11-84"></a><a href="#__codelineno-11-84"><span class="linenos" data-linenos=" 84 "></span></a>
<a id="__codelineno-11-85" name="__codelineno-11-85"></a><a href="#__codelineno-11-85"><span class="linenos" data-linenos=" 85 "></span></a><span class="c1">// 透传同时添加功能</span>
<a id="__codelineno-11-86" name="__codelineno-11-86"></a><a href="#__codelineno-11-86"><span class="linenos" data-linenos=" 86 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">BorderedWindow</span><span class="p">)</span><span class="w"> </span><span class="nx">HandleClick</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-87" name="__codelineno-11-87"></a><a href="#__codelineno-11-87"><span class="linenos" data-linenos=" 87 "></span></a><span class="w">    </span><span class="c1">// 调整坐标以考虑边框</span>
<a id="__codelineno-11-88" name="__codelineno-11-88"></a><a href="#__codelineno-11-88"><span class="linenos" data-linenos=" 88 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">borderWidth</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">borderWidth</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-11-89" name="__codelineno-11-89"></a><a href="#__codelineno-11-89"><span class="linenos" data-linenos=" 89 "></span></a><span class="w">    </span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">GetWidth</span><span class="p">()</span><span class="o">-</span><span class="nx">b</span><span class="p">.</span><span class="nx">borderWidth</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">GetHeight</span><span class="p">()</span><span class="o">-</span><span class="nx">b</span><span class="p">.</span><span class="nx">borderWidth</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-90" name="__codelineno-11-90"></a><a href="#__codelineno-11-90"><span class="linenos" data-linenos=" 90 "></span></a><span class="w">        </span><span class="nb">println</span><span class="p">(</span><span class="s">&quot;Clicked on border&quot;</span><span class="p">)</span>
<a id="__codelineno-11-91" name="__codelineno-11-91"></a><a href="#__codelineno-11-91"><span class="linenos" data-linenos=" 91 "></span></a><span class="w">        </span><span class="k">return</span>
<a id="__codelineno-11-92" name="__codelineno-11-92"></a><a href="#__codelineno-11-92"><span class="linenos" data-linenos=" 92 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-93" name="__codelineno-11-93"></a><a href="#__codelineno-11-93"><span class="linenos" data-linenos=" 93 "></span></a><span class="w">    </span><span class="c1">// 传递调整后的坐标</span>
<a id="__codelineno-11-94" name="__codelineno-11-94"></a><a href="#__codelineno-11-94"><span class="linenos" data-linenos=" 94 "></span></a><span class="w">    </span><span class="nx">b</span><span class="p">.</span><span class="nx">window</span><span class="p">.</span><span class="nx">HandleClick</span><span class="p">(</span><span class="nx">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">borderWidth</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">borderWidth</span><span class="p">)</span>
<a id="__codelineno-11-95" name="__codelineno-11-95"></a><a href="#__codelineno-11-95"><span class="linenos" data-linenos=" 95 "></span></a><span class="p">}</span>
<a id="__codelineno-11-96" name="__codelineno-11-96"></a><a href="#__codelineno-11-96"><span class="linenos" data-linenos=" 96 "></span></a>
<a id="__codelineno-11-97" name="__codelineno-11-97"></a><a href="#__codelineno-11-97"><span class="linenos" data-linenos=" 97 "></span></a><span class="c1">// 客户端代码变得复杂且有许多透传调用</span>
<a id="__codelineno-11-98" name="__codelineno-11-98"></a><a href="#__codelineno-11-98"><span class="linenos" data-linenos=" 98 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-99" name="__codelineno-11-99"></a><a href="#__codelineno-11-99"><span class="linenos" data-linenos=" 99 "></span></a><span class="w">    </span><span class="nx">basicWindow</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">BasicWindow</span><span class="p">{</span><span class="nx">width</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="p">:</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Hello&quot;</span><span class="p">}</span>
<a id="__codelineno-11-100" name="__codelineno-11-100"></a><a href="#__codelineno-11-100"><span class="linenos" data-linenos="100 "></span></a><span class="w">    </span><span class="nx">scrollable</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">ScrollableWindow</span><span class="p">{</span><span class="nx">window</span><span class="p">:</span><span class="w"> </span><span class="nx">basicWindow</span><span class="p">,</span><span class="w"> </span><span class="nx">scrollX</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">scrollY</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">}</span>
<a id="__codelineno-11-101" name="__codelineno-11-101"></a><a href="#__codelineno-11-101"><span class="linenos" data-linenos="101 "></span></a><span class="w">    </span><span class="nx">bordered</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">BorderedWindow</span><span class="p">{</span><span class="nx">window</span><span class="p">:</span><span class="w"> </span><span class="nx">scrollable</span><span class="p">,</span><span class="w"> </span><span class="nx">borderWidth</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">}</span>
<a id="__codelineno-11-102" name="__codelineno-11-102"></a><a href="#__codelineno-11-102"><span class="linenos" data-linenos="102 "></span></a>
<a id="__codelineno-11-103" name="__codelineno-11-103"></a><a href="#__codelineno-11-103"><span class="linenos" data-linenos="103 "></span></a><span class="w">    </span><span class="c1">// 使用最终的装饰后窗口</span>
<a id="__codelineno-11-104" name="__codelineno-11-104"></a><a href="#__codelineno-11-104"><span class="linenos" data-linenos="104 "></span></a><span class="w">    </span><span class="nx">bordered</span><span class="p">.</span><span class="nx">Draw</span><span class="p">()</span><span class="w"> </span><span class="c1">// 调用会级联通过多个装饰器</span>
<a id="__codelineno-11-105" name="__codelineno-11-105"></a><a href="#__codelineno-11-105"><span class="linenos" data-linenos="105 "></span></a><span class="p">}</span>
<a id="__codelineno-11-106" name="__codelineno-11-106"></a><a href="#__codelineno-11-106"><span class="linenos" data-linenos="106 "></span></a>
<a id="__codelineno-11-107" name="__codelineno-11-107"></a><a href="#__codelineno-11-107"><span class="linenos" data-linenos="107 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">isScrollbarClick</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-108" name="__codelineno-11-108"></a><a href="#__codelineno-11-108"><span class="linenos" data-linenos="108 "></span></a><span class="w">    </span><span class="c1">// 判断点击是否在滚动条上</span>
<a id="__codelineno-11-109" name="__codelineno-11-109"></a><a href="#__codelineno-11-109"><span class="linenos" data-linenos="109 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c1">// 简化实现</span>
<a id="__codelineno-11-110" name="__codelineno-11-110"></a><a href="#__codelineno-11-110"><span class="linenos" data-linenos="110 "></span></a><span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-go highlight"><span class="filename">Go</span><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><a href="#__codelineno-12-1"><span class="linenos" data-linenos="  1 "></span></a><span class="c1">// 更好的设计：整合功能，避免多层装饰</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><a href="#__codelineno-12-2"><span class="linenos" data-linenos="  2 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">EnhancedWindow</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><a href="#__codelineno-12-3"><span class="linenos" data-linenos="  3 "></span></a><span class="w">    </span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="w"> </span><span class="kt">int</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><a href="#__codelineno-12-4"><span class="linenos" data-linenos="  4 "></span></a><span class="w">    </span><span class="nx">content</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a><a href="#__codelineno-12-5"><span class="linenos" data-linenos="  5 "></span></a><span class="w">    </span><span class="nx">hasScrollbars</span><span class="w"> </span><span class="kt">bool</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a><a href="#__codelineno-12-6"><span class="linenos" data-linenos="  6 "></span></a><span class="w">    </span><span class="nx">scrollX</span><span class="p">,</span><span class="w"> </span><span class="nx">scrollY</span><span class="w"> </span><span class="kt">int</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a><a href="#__codelineno-12-7"><span class="linenos" data-linenos="  7 "></span></a><span class="w">    </span><span class="nx">hasBorder</span><span class="w"> </span><span class="kt">bool</span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a><a href="#__codelineno-12-8"><span class="linenos" data-linenos="  8 "></span></a><span class="w">    </span><span class="nx">borderWidth</span><span class="w"> </span><span class="kt">int</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a><a href="#__codelineno-12-9"><span class="linenos" data-linenos="  9 "></span></a><span class="p">}</span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a><a href="#__codelineno-12-10"><span class="linenos" data-linenos=" 10 "></span></a>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a><a href="#__codelineno-12-11"><span class="linenos" data-linenos=" 11 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="nx">EnhancedWindow</span><span class="p">)</span><span class="w"> </span><span class="nx">Draw</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-12" name="__codelineno-12-12"></a><a href="#__codelineno-12-12"><span class="linenos" data-linenos=" 12 "></span></a><span class="w">    </span><span class="nb">println</span><span class="p">(</span><span class="s">&quot;Drawing window with content:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
<a id="__codelineno-12-13" name="__codelineno-12-13"></a><a href="#__codelineno-12-13"><span class="linenos" data-linenos=" 13 "></span></a>
<a id="__codelineno-12-14" name="__codelineno-12-14"></a><a href="#__codelineno-12-14"><span class="linenos" data-linenos=" 14 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">hasBorder</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-15" name="__codelineno-12-15"></a><a href="#__codelineno-12-15"><span class="linenos" data-linenos=" 15 "></span></a><span class="w">        </span><span class="nb">println</span><span class="p">(</span><span class="s">&quot;Drawing border with width:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">borderWidth</span><span class="p">)</span>
<a id="__codelineno-12-16" name="__codelineno-12-16"></a><a href="#__codelineno-12-16"><span class="linenos" data-linenos=" 16 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-17" name="__codelineno-12-17"></a><a href="#__codelineno-12-17"><span class="linenos" data-linenos=" 17 "></span></a>
<a id="__codelineno-12-18" name="__codelineno-12-18"></a><a href="#__codelineno-12-18"><span class="linenos" data-linenos=" 18 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">hasScrollbars</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-19" name="__codelineno-12-19"></a><a href="#__codelineno-12-19"><span class="linenos" data-linenos=" 19 "></span></a><span class="w">        </span><span class="nb">println</span><span class="p">(</span><span class="s">&quot;Drawing scrollbars at position:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">scrollX</span><span class="p">,</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">scrollY</span><span class="p">)</span>
<a id="__codelineno-12-20" name="__codelineno-12-20"></a><a href="#__codelineno-12-20"><span class="linenos" data-linenos=" 20 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-21" name="__codelineno-12-21"></a><a href="#__codelineno-12-21"><span class="linenos" data-linenos=" 21 "></span></a><span class="p">}</span>
<a id="__codelineno-12-22" name="__codelineno-12-22"></a><a href="#__codelineno-12-22"><span class="linenos" data-linenos=" 22 "></span></a>
<a id="__codelineno-12-23" name="__codelineno-12-23"></a><a href="#__codelineno-12-23"><span class="linenos" data-linenos=" 23 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="nx">EnhancedWindow</span><span class="p">)</span><span class="w"> </span><span class="nx">GetWidth</span><span class="p">()</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-24" name="__codelineno-12-24"></a><a href="#__codelineno-12-24"><span class="linenos" data-linenos=" 24 "></span></a><span class="w">    </span><span class="nx">totalWidth</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">width</span>
<a id="__codelineno-12-25" name="__codelineno-12-25"></a><a href="#__codelineno-12-25"><span class="linenos" data-linenos=" 25 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">hasBorder</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-26" name="__codelineno-12-26"></a><a href="#__codelineno-12-26"><span class="linenos" data-linenos=" 26 "></span></a><span class="w">        </span><span class="nx">totalWidth</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">borderWidth</span>
<a id="__codelineno-12-27" name="__codelineno-12-27"></a><a href="#__codelineno-12-27"><span class="linenos" data-linenos=" 27 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-28" name="__codelineno-12-28"></a><a href="#__codelineno-12-28"><span class="linenos" data-linenos=" 28 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">totalWidth</span>
<a id="__codelineno-12-29" name="__codelineno-12-29"></a><a href="#__codelineno-12-29"><span class="linenos" data-linenos=" 29 "></span></a><span class="p">}</span>
<a id="__codelineno-12-30" name="__codelineno-12-30"></a><a href="#__codelineno-12-30"><span class="linenos" data-linenos=" 30 "></span></a>
<a id="__codelineno-12-31" name="__codelineno-12-31"></a><a href="#__codelineno-12-31"><span class="linenos" data-linenos=" 31 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="nx">EnhancedWindow</span><span class="p">)</span><span class="w"> </span><span class="nx">GetHeight</span><span class="p">()</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-32" name="__codelineno-12-32"></a><a href="#__codelineno-12-32"><span class="linenos" data-linenos=" 32 "></span></a><span class="w">    </span><span class="nx">totalHeight</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">height</span>
<a id="__codelineno-12-33" name="__codelineno-12-33"></a><a href="#__codelineno-12-33"><span class="linenos" data-linenos=" 33 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">hasBorder</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-34" name="__codelineno-12-34"></a><a href="#__codelineno-12-34"><span class="linenos" data-linenos=" 34 "></span></a><span class="w">        </span><span class="nx">totalHeight</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">borderWidth</span>
<a id="__codelineno-12-35" name="__codelineno-12-35"></a><a href="#__codelineno-12-35"><span class="linenos" data-linenos=" 35 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-36" name="__codelineno-12-36"></a><a href="#__codelineno-12-36"><span class="linenos" data-linenos=" 36 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">totalHeight</span>
<a id="__codelineno-12-37" name="__codelineno-12-37"></a><a href="#__codelineno-12-37"><span class="linenos" data-linenos=" 37 "></span></a><span class="p">}</span>
<a id="__codelineno-12-38" name="__codelineno-12-38"></a><a href="#__codelineno-12-38"><span class="linenos" data-linenos=" 38 "></span></a>
<a id="__codelineno-12-39" name="__codelineno-12-39"></a><a href="#__codelineno-12-39"><span class="linenos" data-linenos=" 39 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="o">*</span><span class="nx">EnhancedWindow</span><span class="p">)</span><span class="w"> </span><span class="nx">HandleClick</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-40" name="__codelineno-12-40"></a><a href="#__codelineno-12-40"><span class="linenos" data-linenos=" 40 "></span></a><span class="w">    </span><span class="c1">// 处理边框点击</span>
<a id="__codelineno-12-41" name="__codelineno-12-41"></a><a href="#__codelineno-12-41"><span class="linenos" data-linenos=" 41 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">hasBorder</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-42" name="__codelineno-12-42"></a><a href="#__codelineno-12-42"><span class="linenos" data-linenos=" 42 "></span></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">borderWidth</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">borderWidth</span><span class="w"> </span><span class="o">||</span>
<a id="__codelineno-12-43" name="__codelineno-12-43"></a><a href="#__codelineno-12-43"><span class="linenos" data-linenos=" 43 "></span></a><span class="w">        </span><span class="nx">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">GetWidth</span><span class="p">()</span><span class="o">-</span><span class="nx">w</span><span class="p">.</span><span class="nx">borderWidth</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">GetHeight</span><span class="p">()</span><span class="o">-</span><span class="nx">w</span><span class="p">.</span><span class="nx">borderWidth</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-44" name="__codelineno-12-44"></a><a href="#__codelineno-12-44"><span class="linenos" data-linenos=" 44 "></span></a><span class="w">            </span><span class="nb">println</span><span class="p">(</span><span class="s">&quot;Clicked on border&quot;</span><span class="p">)</span>
<a id="__codelineno-12-45" name="__codelineno-12-45"></a><a href="#__codelineno-12-45"><span class="linenos" data-linenos=" 45 "></span></a><span class="w">            </span><span class="k">return</span>
<a id="__codelineno-12-46" name="__codelineno-12-46"></a><a href="#__codelineno-12-46"><span class="linenos" data-linenos=" 46 "></span></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-12-47" name="__codelineno-12-47"></a><a href="#__codelineno-12-47"><span class="linenos" data-linenos=" 47 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-48" name="__codelineno-12-48"></a><a href="#__codelineno-12-48"><span class="linenos" data-linenos=" 48 "></span></a>
<a id="__codelineno-12-49" name="__codelineno-12-49"></a><a href="#__codelineno-12-49"><span class="linenos" data-linenos=" 49 "></span></a><span class="w">    </span><span class="c1">// 处理滚动条点击</span>
<a id="__codelineno-12-50" name="__codelineno-12-50"></a><a href="#__codelineno-12-50"><span class="linenos" data-linenos=" 50 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">hasScrollbars</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">isScrollbarArea</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-51" name="__codelineno-12-51"></a><a href="#__codelineno-12-51"><span class="linenos" data-linenos=" 51 "></span></a><span class="w">        </span><span class="nb">println</span><span class="p">(</span><span class="s">&quot;Adjusting scroll position&quot;</span><span class="p">)</span>
<a id="__codelineno-12-52" name="__codelineno-12-52"></a><a href="#__codelineno-12-52"><span class="linenos" data-linenos=" 52 "></span></a><span class="w">        </span><span class="k">return</span>
<a id="__codelineno-12-53" name="__codelineno-12-53"></a><a href="#__codelineno-12-53"><span class="linenos" data-linenos=" 53 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-54" name="__codelineno-12-54"></a><a href="#__codelineno-12-54"><span class="linenos" data-linenos=" 54 "></span></a>
<a id="__codelineno-12-55" name="__codelineno-12-55"></a><a href="#__codelineno-12-55"><span class="linenos" data-linenos=" 55 "></span></a><span class="w">    </span><span class="c1">// 处理内容区域点击</span>
<a id="__codelineno-12-56" name="__codelineno-12-56"></a><a href="#__codelineno-12-56"><span class="linenos" data-linenos=" 56 "></span></a><span class="w">    </span><span class="nx">effectiveX</span><span class="p">,</span><span class="w"> </span><span class="nx">effectiveY</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span>
<a id="__codelineno-12-57" name="__codelineno-12-57"></a><a href="#__codelineno-12-57"><span class="linenos" data-linenos=" 57 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">hasBorder</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-58" name="__codelineno-12-58"></a><a href="#__codelineno-12-58"><span class="linenos" data-linenos=" 58 "></span></a><span class="w">        </span><span class="nx">effectiveX</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">borderWidth</span>
<a id="__codelineno-12-59" name="__codelineno-12-59"></a><a href="#__codelineno-12-59"><span class="linenos" data-linenos=" 59 "></span></a><span class="w">        </span><span class="nx">effectiveY</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">borderWidth</span>
<a id="__codelineno-12-60" name="__codelineno-12-60"></a><a href="#__codelineno-12-60"><span class="linenos" data-linenos=" 60 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-61" name="__codelineno-12-61"></a><a href="#__codelineno-12-61"><span class="linenos" data-linenos=" 61 "></span></a><span class="w">    </span><span class="nb">println</span><span class="p">(</span><span class="s">&quot;Clicked content at:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">effectiveX</span><span class="p">,</span><span class="w"> </span><span class="nx">effectiveY</span><span class="p">)</span>
<a id="__codelineno-12-62" name="__codelineno-12-62"></a><a href="#__codelineno-12-62"><span class="linenos" data-linenos=" 62 "></span></a><span class="p">}</span>
<a id="__codelineno-12-63" name="__codelineno-12-63"></a><a href="#__codelineno-12-63"><span class="linenos" data-linenos=" 63 "></span></a>
<a id="__codelineno-12-64" name="__codelineno-12-64"></a><a href="#__codelineno-12-64"><span class="linenos" data-linenos=" 64 "></span></a><span class="c1">// 使用构建器模式创建窗口</span>
<a id="__codelineno-12-65" name="__codelineno-12-65"></a><a href="#__codelineno-12-65"><span class="linenos" data-linenos=" 65 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">WindowBuilder</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-66" name="__codelineno-12-66"></a><a href="#__codelineno-12-66"><span class="linenos" data-linenos=" 66 "></span></a><span class="w">    </span><span class="nx">window</span><span class="w"> </span><span class="o">*</span><span class="nx">EnhancedWindow</span>
<a id="__codelineno-12-67" name="__codelineno-12-67"></a><a href="#__codelineno-12-67"><span class="linenos" data-linenos=" 67 "></span></a><span class="p">}</span>
<a id="__codelineno-12-68" name="__codelineno-12-68"></a><a href="#__codelineno-12-68"><span class="linenos" data-linenos=" 68 "></span></a>
<a id="__codelineno-12-69" name="__codelineno-12-69"></a><a href="#__codelineno-12-69"><span class="linenos" data-linenos=" 69 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewWindowBuilder</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">WindowBuilder</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-70" name="__codelineno-12-70"></a><a href="#__codelineno-12-70"><span class="linenos" data-linenos=" 70 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">WindowBuilder</span><span class="p">{</span>
<a id="__codelineno-12-71" name="__codelineno-12-71"></a><a href="#__codelineno-12-71"><span class="linenos" data-linenos=" 71 "></span></a><span class="w">        </span><span class="nx">window</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">EnhancedWindow</span><span class="p">{</span>
<a id="__codelineno-12-72" name="__codelineno-12-72"></a><a href="#__codelineno-12-72"><span class="linenos" data-linenos=" 72 "></span></a><span class="w">            </span><span class="nx">width</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-12-73" name="__codelineno-12-73"></a><a href="#__codelineno-12-73"><span class="linenos" data-linenos=" 73 "></span></a><span class="w">            </span><span class="nx">height</span><span class="p">:</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span>
<a id="__codelineno-12-74" name="__codelineno-12-74"></a><a href="#__codelineno-12-74"><span class="linenos" data-linenos=" 74 "></span></a><span class="w">            </span><span class="nx">content</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Default content&quot;</span><span class="p">,</span>
<a id="__codelineno-12-75" name="__codelineno-12-75"></a><a href="#__codelineno-12-75"><span class="linenos" data-linenos=" 75 "></span></a><span class="w">        </span><span class="p">},</span>
<a id="__codelineno-12-76" name="__codelineno-12-76"></a><a href="#__codelineno-12-76"><span class="linenos" data-linenos=" 76 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-77" name="__codelineno-12-77"></a><a href="#__codelineno-12-77"><span class="linenos" data-linenos=" 77 "></span></a><span class="p">}</span>
<a id="__codelineno-12-78" name="__codelineno-12-78"></a><a href="#__codelineno-12-78"><span class="linenos" data-linenos=" 78 "></span></a>
<a id="__codelineno-12-79" name="__codelineno-12-79"></a><a href="#__codelineno-12-79"><span class="linenos" data-linenos=" 79 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">WindowBuilder</span><span class="p">)</span><span class="w"> </span><span class="nx">WithSize</span><span class="p">(</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">WindowBuilder</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-80" name="__codelineno-12-80"></a><a href="#__codelineno-12-80"><span class="linenos" data-linenos=" 80 "></span></a><span class="w">    </span><span class="nx">b</span><span class="p">.</span><span class="nx">window</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">width</span>
<a id="__codelineno-12-81" name="__codelineno-12-81"></a><a href="#__codelineno-12-81"><span class="linenos" data-linenos=" 81 "></span></a><span class="w">    </span><span class="nx">b</span><span class="p">.</span><span class="nx">window</span><span class="p">.</span><span class="nx">height</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">height</span>
<a id="__codelineno-12-82" name="__codelineno-12-82"></a><a href="#__codelineno-12-82"><span class="linenos" data-linenos=" 82 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">b</span>
<a id="__codelineno-12-83" name="__codelineno-12-83"></a><a href="#__codelineno-12-83"><span class="linenos" data-linenos=" 83 "></span></a><span class="p">}</span>
<a id="__codelineno-12-84" name="__codelineno-12-84"></a><a href="#__codelineno-12-84"><span class="linenos" data-linenos=" 84 "></span></a>
<a id="__codelineno-12-85" name="__codelineno-12-85"></a><a href="#__codelineno-12-85"><span class="linenos" data-linenos=" 85 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">WindowBuilder</span><span class="p">)</span><span class="w"> </span><span class="nx">WithContent</span><span class="p">(</span><span class="nx">content</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">WindowBuilder</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-86" name="__codelineno-12-86"></a><a href="#__codelineno-12-86"><span class="linenos" data-linenos=" 86 "></span></a><span class="w">    </span><span class="nx">b</span><span class="p">.</span><span class="nx">window</span><span class="p">.</span><span class="nx">content</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">content</span>
<a id="__codelineno-12-87" name="__codelineno-12-87"></a><a href="#__codelineno-12-87"><span class="linenos" data-linenos=" 87 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">b</span>
<a id="__codelineno-12-88" name="__codelineno-12-88"></a><a href="#__codelineno-12-88"><span class="linenos" data-linenos=" 88 "></span></a><span class="p">}</span>
<a id="__codelineno-12-89" name="__codelineno-12-89"></a><a href="#__codelineno-12-89"><span class="linenos" data-linenos=" 89 "></span></a>
<a id="__codelineno-12-90" name="__codelineno-12-90"></a><a href="#__codelineno-12-90"><span class="linenos" data-linenos=" 90 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">WindowBuilder</span><span class="p">)</span><span class="w"> </span><span class="nx">WithScrollbars</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">WindowBuilder</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-91" name="__codelineno-12-91"></a><a href="#__codelineno-12-91"><span class="linenos" data-linenos=" 91 "></span></a><span class="w">    </span><span class="nx">b</span><span class="p">.</span><span class="nx">window</span><span class="p">.</span><span class="nx">hasScrollbars</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<a id="__codelineno-12-92" name="__codelineno-12-92"></a><a href="#__codelineno-12-92"><span class="linenos" data-linenos=" 92 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">b</span>
<a id="__codelineno-12-93" name="__codelineno-12-93"></a><a href="#__codelineno-12-93"><span class="linenos" data-linenos=" 93 "></span></a><span class="p">}</span>
<a id="__codelineno-12-94" name="__codelineno-12-94"></a><a href="#__codelineno-12-94"><span class="linenos" data-linenos=" 94 "></span></a>
<a id="__codelineno-12-95" name="__codelineno-12-95"></a><a href="#__codelineno-12-95"><span class="linenos" data-linenos=" 95 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">WindowBuilder</span><span class="p">)</span><span class="w"> </span><span class="nx">WithBorder</span><span class="p">(</span><span class="nx">width</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">WindowBuilder</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-96" name="__codelineno-12-96"></a><a href="#__codelineno-12-96"><span class="linenos" data-linenos=" 96 "></span></a><span class="w">    </span><span class="nx">b</span><span class="p">.</span><span class="nx">window</span><span class="p">.</span><span class="nx">hasBorder</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<a id="__codelineno-12-97" name="__codelineno-12-97"></a><a href="#__codelineno-12-97"><span class="linenos" data-linenos=" 97 "></span></a><span class="w">    </span><span class="nx">b</span><span class="p">.</span><span class="nx">window</span><span class="p">.</span><span class="nx">borderWidth</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">width</span>
<a id="__codelineno-12-98" name="__codelineno-12-98"></a><a href="#__codelineno-12-98"><span class="linenos" data-linenos=" 98 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">b</span>
<a id="__codelineno-12-99" name="__codelineno-12-99"></a><a href="#__codelineno-12-99"><span class="linenos" data-linenos=" 99 "></span></a><span class="p">}</span>
<a id="__codelineno-12-100" name="__codelineno-12-100"></a><a href="#__codelineno-12-100"><span class="linenos" data-linenos="100 "></span></a>
<a id="__codelineno-12-101" name="__codelineno-12-101"></a><a href="#__codelineno-12-101"><span class="linenos" data-linenos="101 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">WindowBuilder</span><span class="p">)</span><span class="w"> </span><span class="nx">Build</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">EnhancedWindow</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-102" name="__codelineno-12-102"></a><a href="#__codelineno-12-102"><span class="linenos" data-linenos="102 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">window</span>
<a id="__codelineno-12-103" name="__codelineno-12-103"></a><a href="#__codelineno-12-103"><span class="linenos" data-linenos="103 "></span></a><span class="p">}</span>
<a id="__codelineno-12-104" name="__codelineno-12-104"></a><a href="#__codelineno-12-104"><span class="linenos" data-linenos="104 "></span></a>
<a id="__codelineno-12-105" name="__codelineno-12-105"></a><a href="#__codelineno-12-105"><span class="linenos" data-linenos="105 "></span></a><span class="c1">// 更简洁的客户端代码</span>
<a id="__codelineno-12-106" name="__codelineno-12-106"></a><a href="#__codelineno-12-106"><span class="linenos" data-linenos="106 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-107" name="__codelineno-12-107"></a><a href="#__codelineno-12-107"><span class="linenos" data-linenos="107 "></span></a><span class="w">    </span><span class="nx">window</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewWindowBuilder</span><span class="p">().</span>
<a id="__codelineno-12-108" name="__codelineno-12-108"></a><a href="#__codelineno-12-108"><span class="linenos" data-linenos="108 "></span></a><span class="w">        </span><span class="nx">WithSize</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">).</span>
<a id="__codelineno-12-109" name="__codelineno-12-109"></a><a href="#__codelineno-12-109"><span class="linenos" data-linenos="109 "></span></a><span class="w">        </span><span class="nx">WithContent</span><span class="p">(</span><span class="s">&quot;Hello World&quot;</span><span class="p">).</span>
<a id="__codelineno-12-110" name="__codelineno-12-110"></a><a href="#__codelineno-12-110"><span class="linenos" data-linenos="110 "></span></a><span class="w">        </span><span class="nx">WithScrollbars</span><span class="p">().</span>
<a id="__codelineno-12-111" name="__codelineno-12-111"></a><a href="#__codelineno-12-111"><span class="linenos" data-linenos="111 "></span></a><span class="w">        </span><span class="nx">WithBorder</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span>
<a id="__codelineno-12-112" name="__codelineno-12-112"></a><a href="#__codelineno-12-112"><span class="linenos" data-linenos="112 "></span></a><span class="w">        </span><span class="nx">Build</span><span class="p">()</span>
<a id="__codelineno-12-113" name="__codelineno-12-113"></a><a href="#__codelineno-12-113"><span class="linenos" data-linenos="113 "></span></a>
<a id="__codelineno-12-114" name="__codelineno-12-114"></a><a href="#__codelineno-12-114"><span class="linenos" data-linenos="114 "></span></a><span class="w">    </span><span class="nx">window</span><span class="p">.</span><span class="nx">Draw</span><span class="p">()</span><span class="w"> </span><span class="c1">// 一次调用完成所有绘制</span>
<a id="__codelineno-12-115" name="__codelineno-12-115"></a><a href="#__codelineno-12-115"><span class="linenos" data-linenos="115 "></span></a><span class="p">}</span>
<a id="__codelineno-12-116" name="__codelineno-12-116"></a><a href="#__codelineno-12-116"><span class="linenos" data-linenos="116 "></span></a>
<a id="__codelineno-12-117" name="__codelineno-12-117"></a><a href="#__codelineno-12-117"><span class="linenos" data-linenos="117 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">isScrollbarArea</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-118" name="__codelineno-12-118"></a><a href="#__codelineno-12-118"><span class="linenos" data-linenos="118 "></span></a><span class="w">    </span><span class="c1">// 判断是否在滚动条区域</span>
<a id="__codelineno-12-119" name="__codelineno-12-119"></a><a href="#__codelineno-12-119"><span class="linenos" data-linenos="119 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c1">// 简化实现</span>
<a id="__codelineno-12-120" name="__codelineno-12-120"></a><a href="#__codelineno-12-120"><span class="linenos" data-linenos="120 "></span></a><span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p><strong>6. 接口与实现的分离</strong></p>
<p><strong>类的接口应该与其实现不同</strong>：内部使用的表示形式应与接口中出现的抽象不同。如果两者使用相似抽象，则该类可能不够深。</p>
<ul>
<li>示例：文本编辑器中，内部按行存储文本但提供字符级操作接口比提供完全基于行的API更有价值</li>
</ul>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">不好的设计：接口反映了内部实现</label><label for="__tabbed_4_2">更好的设计：接口独立于内部实现</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-go highlight"><span class="filename">Go</span><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><a href="#__codelineno-13-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="c1">// 不好的设计：接口反映了内部实现（基于行）</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><a href="#__codelineno-13-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">TextStorage</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><a href="#__codelineno-13-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">    </span><span class="nx">lines</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><a href="#__codelineno-13-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="p">}</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><a href="#__codelineno-13-5"><span class="linenos" data-linenos=" 5 "></span></a>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a><a href="#__codelineno-13-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="c1">// 基于行的API暴露了实现细节</span>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a><a href="#__codelineno-13-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">TextStorage</span><span class="p">)</span><span class="w"> </span><span class="nx">GetLine</span><span class="p">(</span><span class="nx">lineNum</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a><a href="#__codelineno-13-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">lineNum</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a><a href="#__codelineno-13-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">lineNum</span><span class="p">]</span>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a><a href="#__codelineno-13-10"><span class="linenos" data-linenos="10 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a><a href="#__codelineno-13-11"><span class="linenos" data-linenos="11 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<a id="__codelineno-13-12" name="__codelineno-13-12"></a><a href="#__codelineno-13-12"><span class="linenos" data-linenos="12 "></span></a><span class="p">}</span>
<a id="__codelineno-13-13" name="__codelineno-13-13"></a><a href="#__codelineno-13-13"><span class="linenos" data-linenos="13 "></span></a>
<a id="__codelineno-13-14" name="__codelineno-13-14"></a><a href="#__codelineno-13-14"><span class="linenos" data-linenos="14 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">TextStorage</span><span class="p">)</span><span class="w"> </span><span class="nx">SetLine</span><span class="p">(</span><span class="nx">lineNum</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-15" name="__codelineno-13-15"></a><a href="#__codelineno-13-15"><span class="linenos" data-linenos="15 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">lineNum</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-16" name="__codelineno-13-16"></a><a href="#__codelineno-13-16"><span class="linenos" data-linenos="16 "></span></a><span class="w">        </span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">lineNum</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">content</span>
<a id="__codelineno-13-17" name="__codelineno-13-17"></a><a href="#__codelineno-13-17"><span class="linenos" data-linenos="17 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-13-18" name="__codelineno-13-18"></a><a href="#__codelineno-13-18"><span class="linenos" data-linenos="18 "></span></a><span class="p">}</span>
<a id="__codelineno-13-19" name="__codelineno-13-19"></a><a href="#__codelineno-13-19"><span class="linenos" data-linenos="19 "></span></a>
<a id="__codelineno-13-20" name="__codelineno-13-20"></a><a href="#__codelineno-13-20"><span class="linenos" data-linenos="20 "></span></a><span class="c1">// 客户端代码被迫处理行拆分/合并的复杂性</span>
<a id="__codelineno-13-21" name="__codelineno-13-21"></a><a href="#__codelineno-13-21"><span class="linenos" data-linenos="21 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">clientCode</span><span class="p">(</span><span class="nx">storage</span><span class="w"> </span><span class="o">*</span><span class="nx">TextStorage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-22" name="__codelineno-13-22"></a><a href="#__codelineno-13-22"><span class="linenos" data-linenos="22 "></span></a><span class="w">    </span><span class="c1">// 在第一行中间插入文本，客户端需要处理拆分行的复杂性</span>
<a id="__codelineno-13-23" name="__codelineno-13-23"></a><a href="#__codelineno-13-23"><span class="linenos" data-linenos="23 "></span></a><span class="w">    </span><span class="nx">line</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">storage</span><span class="p">.</span><span class="nx">GetLine</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-13-24" name="__codelineno-13-24"></a><a href="#__codelineno-13-24"><span class="linenos" data-linenos="24 "></span></a><span class="w">    </span><span class="nx">pos</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">5</span>
<a id="__codelineno-13-25" name="__codelineno-13-25"></a><a href="#__codelineno-13-25"><span class="linenos" data-linenos="25 "></span></a><span class="w">    </span><span class="nx">newLine</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">line</span><span class="p">[:</span><span class="nx">pos</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;inserted text&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">line</span><span class="p">[</span><span class="nx">pos</span><span class="p">:]</span>
<a id="__codelineno-13-26" name="__codelineno-13-26"></a><a href="#__codelineno-13-26"><span class="linenos" data-linenos="26 "></span></a><span class="w">    </span><span class="nx">storage</span><span class="p">.</span><span class="nx">SetLine</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">newLine</span><span class="p">)</span>
<a id="__codelineno-13-27" name="__codelineno-13-27"></a><a href="#__codelineno-13-27"><span class="linenos" data-linenos="27 "></span></a>
<a id="__codelineno-13-28" name="__codelineno-13-28"></a><a href="#__codelineno-13-28"><span class="linenos" data-linenos="28 "></span></a><span class="w">    </span><span class="c1">// 删除跨行的文本也很复杂...需要处理多行逻辑</span>
<a id="__codelineno-13-29" name="__codelineno-13-29"></a><a href="#__codelineno-13-29"><span class="linenos" data-linenos="29 "></span></a><span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-go highlight"><span class="filename">Go</span><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><a href="#__codelineno-14-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="c1">// 更好的设计：接口独立于内部实现</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><a href="#__codelineno-14-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">TextBuffer</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><a href="#__codelineno-14-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">    </span><span class="nx">lines</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="w"> </span><span class="c1">// 内部仍基于行存储</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a><a href="#__codelineno-14-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="p">}</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a><a href="#__codelineno-14-5"><span class="linenos" data-linenos=" 5 "></span></a>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a><a href="#__codelineno-14-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="c1">// 提供基于字符位置的接口，隐藏基于行的实现细节</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a><a href="#__codelineno-14-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">TextBuffer</span><span class="p">)</span><span class="w"> </span><span class="nx">Insert</span><span class="p">(</span><span class="nx">pos</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a><a href="#__codelineno-14-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="w">    </span><span class="c1">// 内部处理行的拆分和合并</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a><a href="#__codelineno-14-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="w">    </span><span class="nx">lineNum</span><span class="p">,</span><span class="w"> </span><span class="nx">linePos</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">translatePosition</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a><a href="#__codelineno-14-10"><span class="linenos" data-linenos="10 "></span></a>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a><a href="#__codelineno-14-11"><span class="linenos" data-linenos="11 "></span></a><span class="w">    </span><span class="c1">// 处理插入可能跨越多行的情况</span>
<a id="__codelineno-14-12" name="__codelineno-14-12"></a><a href="#__codelineno-14-12"><span class="linenos" data-linenos="12 "></span></a><span class="w">    </span><span class="nx">currentLine</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">lineNum</span><span class="p">]</span>
<a id="__codelineno-14-13" name="__codelineno-14-13"></a><a href="#__codelineno-14-13"><span class="linenos" data-linenos="13 "></span></a><span class="w">    </span><span class="nx">beforeInsert</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">currentLine</span><span class="p">[:</span><span class="nx">linePos</span><span class="p">]</span>
<a id="__codelineno-14-14" name="__codelineno-14-14"></a><a href="#__codelineno-14-14"><span class="linenos" data-linenos="14 "></span></a><span class="w">    </span><span class="nx">afterInsert</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">currentLine</span><span class="p">[</span><span class="nx">linePos</span><span class="p">:]</span>
<a id="__codelineno-14-15" name="__codelineno-14-15"></a><a href="#__codelineno-14-15"><span class="linenos" data-linenos="15 "></span></a>
<a id="__codelineno-14-16" name="__codelineno-14-16"></a><a href="#__codelineno-14-16"><span class="linenos" data-linenos="16 "></span></a><span class="w">    </span><span class="c1">// 处理文本中的换行符</span>
<a id="__codelineno-14-17" name="__codelineno-14-17"></a><a href="#__codelineno-14-17"><span class="linenos" data-linenos="17 "></span></a><span class="w">    </span><span class="nx">textLines</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">splitLines</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>
<a id="__codelineno-14-18" name="__codelineno-14-18"></a><a href="#__codelineno-14-18"><span class="linenos" data-linenos="18 "></span></a>
<a id="__codelineno-14-19" name="__codelineno-14-19"></a><a href="#__codelineno-14-19"><span class="linenos" data-linenos="19 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">textLines</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-20" name="__codelineno-14-20"></a><a href="#__codelineno-14-20"><span class="linenos" data-linenos="20 "></span></a><span class="w">        </span><span class="c1">// 简单插入，没有新行</span>
<a id="__codelineno-14-21" name="__codelineno-14-21"></a><a href="#__codelineno-14-21"><span class="linenos" data-linenos="21 "></span></a><span class="w">        </span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">lineNum</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">beforeInsert</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">textLines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">afterInsert</span>
<a id="__codelineno-14-22" name="__codelineno-14-22"></a><a href="#__codelineno-14-22"><span class="linenos" data-linenos="22 "></span></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-23" name="__codelineno-14-23"></a><a href="#__codelineno-14-23"><span class="linenos" data-linenos="23 "></span></a><span class="w">        </span><span class="c1">// 处理多行插入</span>
<a id="__codelineno-14-24" name="__codelineno-14-24"></a><a href="#__codelineno-14-24"><span class="linenos" data-linenos="24 "></span></a><span class="w">        </span><span class="nx">newLines</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-14-25" name="__codelineno-14-25"></a><a href="#__codelineno-14-25"><span class="linenos" data-linenos="25 "></span></a><span class="w">        </span><span class="nx">newLines</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">newLines</span><span class="p">,</span><span class="w"> </span><span class="nx">beforeInsert</span><span class="o">+</span><span class="nx">textLines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-14-26" name="__codelineno-14-26"></a><a href="#__codelineno-14-26"><span class="linenos" data-linenos="26 "></span></a><span class="w">        </span><span class="nx">newLines</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">newLines</span><span class="p">,</span><span class="w"> </span><span class="nx">textLines</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="nx">textLines</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-14-27" name="__codelineno-14-27"></a><a href="#__codelineno-14-27"><span class="linenos" data-linenos="27 "></span></a><span class="w">        </span><span class="nx">newLines</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">newLines</span><span class="p">,</span><span class="w"> </span><span class="nx">textLines</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">textLines</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="nx">afterInsert</span><span class="p">)</span>
<a id="__codelineno-14-28" name="__codelineno-14-28"></a><a href="#__codelineno-14-28"><span class="linenos" data-linenos="28 "></span></a>
<a id="__codelineno-14-29" name="__codelineno-14-29"></a><a href="#__codelineno-14-29"><span class="linenos" data-linenos="29 "></span></a><span class="w">        </span><span class="c1">// 更新行数组</span>
<a id="__codelineno-14-30" name="__codelineno-14-30"></a><a href="#__codelineno-14-30"><span class="linenos" data-linenos="30 "></span></a><span class="w">        </span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">[:</span><span class="nx">lineNum</span><span class="p">],</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">newLines</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">lineNum</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-14-31" name="__codelineno-14-31"></a><a href="#__codelineno-14-31"><span class="linenos" data-linenos="31 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-32" name="__codelineno-14-32"></a><a href="#__codelineno-14-32"><span class="linenos" data-linenos="32 "></span></a><span class="p">}</span>
<a id="__codelineno-14-33" name="__codelineno-14-33"></a><a href="#__codelineno-14-33"><span class="linenos" data-linenos="33 "></span></a>
<a id="__codelineno-14-34" name="__codelineno-14-34"></a><a href="#__codelineno-14-34"><span class="linenos" data-linenos="34 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">TextBuffer</span><span class="p">)</span><span class="w"> </span><span class="nx">Delete</span><span class="p">(</span><span class="nx">startPos</span><span class="p">,</span><span class="w"> </span><span class="nx">endPos</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-35" name="__codelineno-14-35"></a><a href="#__codelineno-14-35"><span class="linenos" data-linenos="35 "></span></a><span class="w">    </span><span class="c1">// 内部处理行的合并</span>
<a id="__codelineno-14-36" name="__codelineno-14-36"></a><a href="#__codelineno-14-36"><span class="linenos" data-linenos="36 "></span></a><span class="w">    </span><span class="nx">startLine</span><span class="p">,</span><span class="w"> </span><span class="nx">startLinePos</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">translatePosition</span><span class="p">(</span><span class="nx">startPos</span><span class="p">)</span>
<a id="__codelineno-14-37" name="__codelineno-14-37"></a><a href="#__codelineno-14-37"><span class="linenos" data-linenos="37 "></span></a><span class="w">    </span><span class="nx">endLine</span><span class="p">,</span><span class="w"> </span><span class="nx">endLinePos</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">translatePosition</span><span class="p">(</span><span class="nx">endPos</span><span class="p">)</span>
<a id="__codelineno-14-38" name="__codelineno-14-38"></a><a href="#__codelineno-14-38"><span class="linenos" data-linenos="38 "></span></a>
<a id="__codelineno-14-39" name="__codelineno-14-39"></a><a href="#__codelineno-14-39"><span class="linenos" data-linenos="39 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">startLine</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">endLine</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-40" name="__codelineno-14-40"></a><a href="#__codelineno-14-40"><span class="linenos" data-linenos="40 "></span></a><span class="w">        </span><span class="c1">// 删除同一行内的文本</span>
<a id="__codelineno-14-41" name="__codelineno-14-41"></a><a href="#__codelineno-14-41"><span class="linenos" data-linenos="41 "></span></a><span class="w">        </span><span class="nx">line</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">startLine</span><span class="p">]</span>
<a id="__codelineno-14-42" name="__codelineno-14-42"></a><a href="#__codelineno-14-42"><span class="linenos" data-linenos="42 "></span></a><span class="w">        </span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">startLine</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">line</span><span class="p">[:</span><span class="nx">startLinePos</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">line</span><span class="p">[</span><span class="nx">endLinePos</span><span class="p">:]</span>
<a id="__codelineno-14-43" name="__codelineno-14-43"></a><a href="#__codelineno-14-43"><span class="linenos" data-linenos="43 "></span></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-44" name="__codelineno-14-44"></a><a href="#__codelineno-14-44"><span class="linenos" data-linenos="44 "></span></a><span class="w">        </span><span class="c1">// 处理跨行删除</span>
<a id="__codelineno-14-45" name="__codelineno-14-45"></a><a href="#__codelineno-14-45"><span class="linenos" data-linenos="45 "></span></a><span class="w">        </span><span class="nx">firstLinePart</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">startLine</span><span class="p">][:</span><span class="nx">startLinePos</span><span class="p">]</span>
<a id="__codelineno-14-46" name="__codelineno-14-46"></a><a href="#__codelineno-14-46"><span class="linenos" data-linenos="46 "></span></a><span class="w">        </span><span class="nx">lastLinePart</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">endLine</span><span class="p">][</span><span class="nx">endLinePos</span><span class="p">:]</span>
<a id="__codelineno-14-47" name="__codelineno-14-47"></a><a href="#__codelineno-14-47"><span class="linenos" data-linenos="47 "></span></a>
<a id="__codelineno-14-48" name="__codelineno-14-48"></a><a href="#__codelineno-14-48"><span class="linenos" data-linenos="48 "></span></a><span class="w">        </span><span class="c1">// 合并首尾行</span>
<a id="__codelineno-14-49" name="__codelineno-14-49"></a><a href="#__codelineno-14-49"><span class="linenos" data-linenos="49 "></span></a><span class="w">        </span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">startLine</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">firstLinePart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">lastLinePart</span>
<a id="__codelineno-14-50" name="__codelineno-14-50"></a><a href="#__codelineno-14-50"><span class="linenos" data-linenos="50 "></span></a>
<a id="__codelineno-14-51" name="__codelineno-14-51"></a><a href="#__codelineno-14-51"><span class="linenos" data-linenos="51 "></span></a><span class="w">        </span><span class="c1">// 移除中间行</span>
<a id="__codelineno-14-52" name="__codelineno-14-52"></a><a href="#__codelineno-14-52"><span class="linenos" data-linenos="52 "></span></a><span class="w">        </span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">[:</span><span class="nx">startLine</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">endLine</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-14-53" name="__codelineno-14-53"></a><a href="#__codelineno-14-53"><span class="linenos" data-linenos="53 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-54" name="__codelineno-14-54"></a><a href="#__codelineno-14-54"><span class="linenos" data-linenos="54 "></span></a><span class="p">}</span>
<a id="__codelineno-14-55" name="__codelineno-14-55"></a><a href="#__codelineno-14-55"><span class="linenos" data-linenos="55 "></span></a>
<a id="__codelineno-14-56" name="__codelineno-14-56"></a><a href="#__codelineno-14-56"><span class="linenos" data-linenos="56 "></span></a><span class="c1">// 辅助方法：将绝对位置转换为行和列</span>
<a id="__codelineno-14-57" name="__codelineno-14-57"></a><a href="#__codelineno-14-57"><span class="linenos" data-linenos="57 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">TextBuffer</span><span class="p">)</span><span class="w"> </span><span class="nx">translatePosition</span><span class="p">(</span><span class="nx">pos</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">line</span><span class="p">,</span><span class="w"> </span><span class="nx">col</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-58" name="__codelineno-14-58"></a><a href="#__codelineno-14-58"><span class="linenos" data-linenos="58 "></span></a><span class="w">    </span><span class="c1">// 实现位置转换逻辑</span>
<a id="__codelineno-14-59" name="__codelineno-14-59"></a><a href="#__codelineno-14-59"><span class="linenos" data-linenos="59 "></span></a><span class="w">    </span><span class="nx">charCount</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span>
<a id="__codelineno-14-60" name="__codelineno-14-60"></a><a href="#__codelineno-14-60"><span class="linenos" data-linenos="60 "></span></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">lineText</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-61" name="__codelineno-14-61"></a><a href="#__codelineno-14-61"><span class="linenos" data-linenos="61 "></span></a><span class="w">        </span><span class="nx">lineLen</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">lineText</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">// +1 是换行符</span>
<a id="__codelineno-14-62" name="__codelineno-14-62"></a><a href="#__codelineno-14-62"><span class="linenos" data-linenos="62 "></span></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">charCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">lineLen</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">pos</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-63" name="__codelineno-14-63"></a><a href="#__codelineno-14-63"><span class="linenos" data-linenos="63 "></span></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">pos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">charCount</span>
<a id="__codelineno-14-64" name="__codelineno-14-64"></a><a href="#__codelineno-14-64"><span class="linenos" data-linenos="64 "></span></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-14-65" name="__codelineno-14-65"></a><a href="#__codelineno-14-65"><span class="linenos" data-linenos="65 "></span></a><span class="w">        </span><span class="nx">charCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">lineLen</span>
<a id="__codelineno-14-66" name="__codelineno-14-66"></a><a href="#__codelineno-14-66"><span class="linenos" data-linenos="66 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-67" name="__codelineno-14-67"></a><a href="#__codelineno-14-67"><span class="linenos" data-linenos="67 "></span></a><span class="w">    </span><span class="c1">// 默认返回最后一行的末尾</span>
<a id="__codelineno-14-68" name="__codelineno-14-68"></a><a href="#__codelineno-14-68"><span class="linenos" data-linenos="68 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-14-69" name="__codelineno-14-69"></a><a href="#__codelineno-14-69"><span class="linenos" data-linenos="69 "></span></a><span class="p">}</span>
<a id="__codelineno-14-70" name="__codelineno-14-70"></a><a href="#__codelineno-14-70"><span class="linenos" data-linenos="70 "></span></a>
<a id="__codelineno-14-71" name="__codelineno-14-71"></a><a href="#__codelineno-14-71"><span class="linenos" data-linenos="71 "></span></a><span class="c1">// 辅助函数：按行分割文本</span>
<a id="__codelineno-14-72" name="__codelineno-14-72"></a><a href="#__codelineno-14-72"><span class="linenos" data-linenos="72 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">splitLines</span><span class="p">(</span><span class="nx">text</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-73" name="__codelineno-14-73"></a><a href="#__codelineno-14-73"><span class="linenos" data-linenos="73 "></span></a><span class="w">    </span><span class="c1">// 实现文本行分割</span>
<a id="__codelineno-14-74" name="__codelineno-14-74"></a><a href="#__codelineno-14-74"><span class="linenos" data-linenos="74 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span>
<a id="__codelineno-14-75" name="__codelineno-14-75"></a><a href="#__codelineno-14-75"><span class="linenos" data-linenos="75 "></span></a><span class="p">}</span>
<a id="__codelineno-14-76" name="__codelineno-14-76"></a><a href="#__codelineno-14-76"><span class="linenos" data-linenos="76 "></span></a>
<a id="__codelineno-14-77" name="__codelineno-14-77"></a><a href="#__codelineno-14-77"><span class="linenos" data-linenos="77 "></span></a><span class="c1">// 客户端代码变得简单多了</span>
<a id="__codelineno-14-78" name="__codelineno-14-78"></a><a href="#__codelineno-14-78"><span class="linenos" data-linenos="78 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">clientCode</span><span class="p">(</span><span class="nx">buffer</span><span class="w"> </span><span class="o">*</span><span class="nx">TextBuffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-79" name="__codelineno-14-79"></a><a href="#__codelineno-14-79"><span class="linenos" data-linenos="79 "></span></a><span class="w">    </span><span class="c1">// 在位置10处插入文本，不需要关心行拆分</span>
<a id="__codelineno-14-80" name="__codelineno-14-80"></a><a href="#__codelineno-14-80"><span class="linenos" data-linenos="80 "></span></a><span class="w">    </span><span class="nx">buffer</span><span class="p">.</span><span class="nx">Insert</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;inserted text&quot;</span><span class="p">)</span>
<a id="__codelineno-14-81" name="__codelineno-14-81"></a><a href="#__codelineno-14-81"><span class="linenos" data-linenos="81 "></span></a>
<a id="__codelineno-14-82" name="__codelineno-14-82"></a><a href="#__codelineno-14-82"><span class="linenos" data-linenos="82 "></span></a><span class="w">    </span><span class="c1">// 删除从位置5到15的文本，不需要处理跨行逻辑</span>
<a id="__codelineno-14-83" name="__codelineno-14-83"></a><a href="#__codelineno-14-83"><span class="linenos" data-linenos="83 "></span></a><span class="w">    </span><span class="nx">buffer</span><span class="p">.</span><span class="nx">Delete</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span>
<a id="__codelineno-14-84" name="__codelineno-14-84"></a><a href="#__codelineno-14-84"><span class="linenos" data-linenos="84 "></span></a><span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="第8章-降低复杂性">第8章 降低复杂性<a class="headerlink" href="#第8章-降低复杂性" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">关键结论</p>
<p>当开发模块时，寻找机会让自己多承担一些痛苦，以减轻用户的负担。这通常意味着：</p>
<ul>
<li>实现更复杂但具有简单接口的模块</li>
<li>避免不必要的配置参数</li>
<li>处理而非传递异常</li>
<li>始终关注整体系统复杂性的降低</li>
</ul>
<p>记住这句话：<strong>"模块拥有简单的接口比拥有简单的实现更重要"</strong>。</p>
</div>
<p><strong>1. 核心思想</strong></p>
<p>本章提出了一个创建更深层次类的关键原则：<strong>复杂性应该向下推移</strong>。当模块开发中遇到不可避免的复杂性时，应该由模块内部处理这种复杂性，而不是将其暴露给模块的使用者。</p>
<p>这一原则基于一个简单的观察：</p>
<ul>
<li>大多数模块的<strong>使用者数量远多于开发者数量</strong></li>
<li>因此，让少数开发者承担复杂性比让众多使用者承担更为合理</li>
<li>表达这个思想的另一种方式：<strong>模块拥有简单的接口比拥有简单的实现更重要</strong></li>
</ul>
<p><strong>2. 开发者的常见误区</strong></p>
<p>作为开发者，我们经常会做出相反的选择：</p>
<table>
<thead>
<tr>
<th>错误的做法</th>
<th>描述</th>
<th>后果</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>抛出异常而非处理</strong></td>
<td>遇到不确定如何处理的情况时，简单地抛出异常让调用者处理</td>
<td>每个调用者都必须处理这个异常，复杂性被放大</td>
</tr>
<tr>
<td><strong>过度使用配置参数</strong></td>
<td>不确定要实施什么策略时，创建配置参数让用户或管理员决定</td>
<td>所有系统管理员都必须学习如何设置这些参数</td>
</tr>
</tbody>
</table>
<p>这些做法虽然短期内使开发更容易，但会导致复杂性的放大，使多人而非一人必须处理问题。</p>
<p><strong>3. 案例分析</strong></p>
<p><strong>3.1 文本编辑器的文本类</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:2"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">向上推移复杂性：行级接口</label><label for="__tabbed_5_2">向下推移复杂性：字符级接口</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-go highlight"><span class="filename">Go</span><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><a href="#__codelineno-15-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="c1">// 向上推移复杂性：简单实现但复杂使用</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><a href="#__codelineno-15-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">LineBasedText</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><a href="#__codelineno-15-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">    </span><span class="nx">lines</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a><a href="#__codelineno-15-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="p">}</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a><a href="#__codelineno-15-5"><span class="linenos" data-linenos=" 5 "></span></a>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a><a href="#__codelineno-15-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">LineBasedText</span><span class="p">)</span><span class="w"> </span><span class="nx">GetLine</span><span class="p">(</span><span class="nx">lineNum</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a><a href="#__codelineno-15-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">lineNum</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-8" name="__codelineno-15-8"></a><a href="#__codelineno-15-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">lineNum</span><span class="p">]</span>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a><a href="#__codelineno-15-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-15-10" name="__codelineno-15-10"></a><a href="#__codelineno-15-10"><span class="linenos" data-linenos="10 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<a id="__codelineno-15-11" name="__codelineno-15-11"></a><a href="#__codelineno-15-11"><span class="linenos" data-linenos="11 "></span></a><span class="p">}</span>
<a id="__codelineno-15-12" name="__codelineno-15-12"></a><a href="#__codelineno-15-12"><span class="linenos" data-linenos="12 "></span></a>
<a id="__codelineno-15-13" name="__codelineno-15-13"></a><a href="#__codelineno-15-13"><span class="linenos" data-linenos="13 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">LineBasedText</span><span class="p">)</span><span class="w"> </span><span class="nx">SetLine</span><span class="p">(</span><span class="nx">lineNum</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-14" name="__codelineno-15-14"></a><a href="#__codelineno-15-14"><span class="linenos" data-linenos="14 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">lineNum</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-15" name="__codelineno-15-15"></a><a href="#__codelineno-15-15"><span class="linenos" data-linenos="15 "></span></a><span class="w">        </span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">lineNum</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">content</span>
<a id="__codelineno-15-16" name="__codelineno-15-16"></a><a href="#__codelineno-15-16"><span class="linenos" data-linenos="16 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-15-17" name="__codelineno-15-17"></a><a href="#__codelineno-15-17"><span class="linenos" data-linenos="17 "></span></a><span class="p">}</span>
<a id="__codelineno-15-18" name="__codelineno-15-18"></a><a href="#__codelineno-15-18"><span class="linenos" data-linenos="18 "></span></a>
<a id="__codelineno-15-19" name="__codelineno-15-19"></a><a href="#__codelineno-15-19"><span class="linenos" data-linenos="19 "></span></a><span class="c1">// 调用代码必须处理行的拆分和合并</span>
<a id="__codelineno-15-20" name="__codelineno-15-20"></a><a href="#__codelineno-15-20"><span class="linenos" data-linenos="20 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">handleUserKeypress</span><span class="p">(</span><span class="nx">text</span><span class="w"> </span><span class="o">*</span><span class="nx">LineBasedText</span><span class="p">,</span><span class="w"> </span><span class="nx">position</span><span class="w"> </span><span class="nx">Position</span><span class="p">,</span><span class="w"> </span><span class="nx">char</span><span class="w"> </span><span class="kt">rune</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-21" name="__codelineno-15-21"></a><a href="#__codelineno-15-21"><span class="linenos" data-linenos="21 "></span></a><span class="w">    </span><span class="c1">// 获取当前行</span>
<a id="__codelineno-15-22" name="__codelineno-15-22"></a><a href="#__codelineno-15-22"><span class="linenos" data-linenos="22 "></span></a><span class="w">    </span><span class="nx">line</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">GetLine</span><span class="p">(</span><span class="nx">position</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span>
<a id="__codelineno-15-23" name="__codelineno-15-23"></a><a href="#__codelineno-15-23"><span class="linenos" data-linenos="23 "></span></a>
<a id="__codelineno-15-24" name="__codelineno-15-24"></a><a href="#__codelineno-15-24"><span class="linenos" data-linenos="24 "></span></a><span class="w">    </span><span class="c1">// 在指定位置插入字符</span>
<a id="__codelineno-15-25" name="__codelineno-15-25"></a><a href="#__codelineno-15-25"><span class="linenos" data-linenos="25 "></span></a><span class="w">    </span><span class="nx">newLine</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">line</span><span class="p">[:</span><span class="nx">position</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">char</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">line</span><span class="p">[</span><span class="nx">position</span><span class="p">.</span><span class="nx">column</span><span class="p">:]</span>
<a id="__codelineno-15-26" name="__codelineno-15-26"></a><a href="#__codelineno-15-26"><span class="linenos" data-linenos="26 "></span></a>
<a id="__codelineno-15-27" name="__codelineno-15-27"></a><a href="#__codelineno-15-27"><span class="linenos" data-linenos="27 "></span></a><span class="w">    </span><span class="c1">// 更新行</span>
<a id="__codelineno-15-28" name="__codelineno-15-28"></a><a href="#__codelineno-15-28"><span class="linenos" data-linenos="28 "></span></a><span class="w">    </span><span class="nx">text</span><span class="p">.</span><span class="nx">SetLine</span><span class="p">(</span><span class="nx">position</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span><span class="w"> </span><span class="nx">newLine</span><span class="p">)</span>
<a id="__codelineno-15-29" name="__codelineno-15-29"></a><a href="#__codelineno-15-29"><span class="linenos" data-linenos="29 "></span></a><span class="p">}</span>
<a id="__codelineno-15-30" name="__codelineno-15-30"></a><a href="#__codelineno-15-30"><span class="linenos" data-linenos="30 "></span></a>
<a id="__codelineno-15-31" name="__codelineno-15-31"></a><a href="#__codelineno-15-31"><span class="linenos" data-linenos="31 "></span></a><span class="c1">// 进行跨行操作更加复杂</span>
<a id="__codelineno-15-32" name="__codelineno-15-32"></a><a href="#__codelineno-15-32"><span class="linenos" data-linenos="32 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">deleteSelection</span><span class="p">(</span><span class="nx">text</span><span class="w"> </span><span class="o">*</span><span class="nx">LineBasedText</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="nx">Position</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-33" name="__codelineno-15-33"></a><a href="#__codelineno-15-33"><span class="linenos" data-linenos="33 "></span></a><span class="w">    </span><span class="c1">// 删除在同一行内</span>
<a id="__codelineno-15-34" name="__codelineno-15-34"></a><a href="#__codelineno-15-34"><span class="linenos" data-linenos="34 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">end</span><span class="p">.</span><span class="nx">line</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-35" name="__codelineno-15-35"></a><a href="#__codelineno-15-35"><span class="linenos" data-linenos="35 "></span></a><span class="w">        </span><span class="nx">line</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">GetLine</span><span class="p">(</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span>
<a id="__codelineno-15-36" name="__codelineno-15-36"></a><a href="#__codelineno-15-36"><span class="linenos" data-linenos="36 "></span></a><span class="w">        </span><span class="nx">newLine</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">line</span><span class="p">[:</span><span class="nx">start</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">line</span><span class="p">[</span><span class="nx">end</span><span class="p">.</span><span class="nx">column</span><span class="p">:]</span>
<a id="__codelineno-15-37" name="__codelineno-15-37"></a><a href="#__codelineno-15-37"><span class="linenos" data-linenos="37 "></span></a><span class="w">        </span><span class="nx">text</span><span class="p">.</span><span class="nx">SetLine</span><span class="p">(</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span><span class="w"> </span><span class="nx">newLine</span><span class="p">)</span>
<a id="__codelineno-15-38" name="__codelineno-15-38"></a><a href="#__codelineno-15-38"><span class="linenos" data-linenos="38 "></span></a><span class="w">        </span><span class="k">return</span>
<a id="__codelineno-15-39" name="__codelineno-15-39"></a><a href="#__codelineno-15-39"><span class="linenos" data-linenos="39 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-15-40" name="__codelineno-15-40"></a><a href="#__codelineno-15-40"><span class="linenos" data-linenos="40 "></span></a>
<a id="__codelineno-15-41" name="__codelineno-15-41"></a><a href="#__codelineno-15-41"><span class="linenos" data-linenos="41 "></span></a><span class="w">    </span><span class="c1">// 跨行删除需要合并行</span>
<a id="__codelineno-15-42" name="__codelineno-15-42"></a><a href="#__codelineno-15-42"><span class="linenos" data-linenos="42 "></span></a><span class="w">    </span><span class="nx">firstLine</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">GetLine</span><span class="p">(</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span>
<a id="__codelineno-15-43" name="__codelineno-15-43"></a><a href="#__codelineno-15-43"><span class="linenos" data-linenos="43 "></span></a><span class="w">    </span><span class="nx">lastLine</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">GetLine</span><span class="p">(</span><span class="nx">end</span><span class="p">.</span><span class="nx">line</span><span class="p">)</span>
<a id="__codelineno-15-44" name="__codelineno-15-44"></a><a href="#__codelineno-15-44"><span class="linenos" data-linenos="44 "></span></a>
<a id="__codelineno-15-45" name="__codelineno-15-45"></a><a href="#__codelineno-15-45"><span class="linenos" data-linenos="45 "></span></a><span class="w">    </span><span class="nx">newLine</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">firstLine</span><span class="p">[:</span><span class="nx">start</span><span class="p">.</span><span class="nx">column</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">lastLine</span><span class="p">[</span><span class="nx">end</span><span class="p">.</span><span class="nx">column</span><span class="p">:]</span>
<a id="__codelineno-15-46" name="__codelineno-15-46"></a><a href="#__codelineno-15-46"><span class="linenos" data-linenos="46 "></span></a><span class="w">    </span><span class="nx">text</span><span class="p">.</span><span class="nx">SetLine</span><span class="p">(</span><span class="nx">start</span><span class="p">.</span><span class="nx">line</span><span class="p">,</span><span class="w"> </span><span class="nx">newLine</span><span class="p">)</span>
<a id="__codelineno-15-47" name="__codelineno-15-47"></a><a href="#__codelineno-15-47"><span class="linenos" data-linenos="47 "></span></a>
<a id="__codelineno-15-48" name="__codelineno-15-48"></a><a href="#__codelineno-15-48"><span class="linenos" data-linenos="48 "></span></a><span class="w">    </span><span class="c1">// 移除中间行的复杂逻辑...</span>
<a id="__codelineno-15-49" name="__codelineno-15-49"></a><a href="#__codelineno-15-49"><span class="linenos" data-linenos="49 "></span></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-15-50" name="__codelineno-15-50"></a><a href="#__codelineno-15-50"><span class="linenos" data-linenos="50 "></span></a><span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-go highlight"><span class="filename">Go</span><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><a href="#__codelineno-16-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="c1">// 向下推移复杂性：实现更复杂但使用更简单</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><a href="#__codelineno-16-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">CharacterBasedText</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><a href="#__codelineno-16-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">    </span><span class="c1">// 内部仍然基于行存储</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><a href="#__codelineno-16-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">    </span><span class="nx">lines</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a><a href="#__codelineno-16-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="p">}</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a><a href="#__codelineno-16-6"><span class="linenos" data-linenos=" 6 "></span></a>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a><a href="#__codelineno-16-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">CharacterBasedText</span><span class="p">)</span><span class="w"> </span><span class="nx">Insert</span><span class="p">(</span><span class="nx">pos</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a><a href="#__codelineno-16-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="w">    </span><span class="c1">// 复杂的插入逻辑被封装在此方法内</span>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a><a href="#__codelineno-16-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="w">    </span><span class="nx">lineNum</span><span class="p">,</span><span class="w"> </span><span class="nx">linePos</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">positionToLineAndColumn</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a><a href="#__codelineno-16-10"><span class="linenos" data-linenos="10 "></span></a>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a><a href="#__codelineno-16-11"><span class="linenos" data-linenos="11 "></span></a><span class="w">    </span><span class="c1">// 处理可能跨行的插入</span>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a><a href="#__codelineno-16-12"><span class="linenos" data-linenos="12 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Contains</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-13" name="__codelineno-16-13"></a><a href="#__codelineno-16-13"><span class="linenos" data-linenos="13 "></span></a><span class="w">        </span><span class="c1">// 简单插入不涉及新行</span>
<a id="__codelineno-16-14" name="__codelineno-16-14"></a><a href="#__codelineno-16-14"><span class="linenos" data-linenos="14 "></span></a><span class="w">        </span><span class="nx">line</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">lineNum</span><span class="p">]</span>
<a id="__codelineno-16-15" name="__codelineno-16-15"></a><a href="#__codelineno-16-15"><span class="linenos" data-linenos="15 "></span></a><span class="w">        </span><span class="nx">t</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">lineNum</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">line</span><span class="p">[:</span><span class="nx">linePos</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">line</span><span class="p">[</span><span class="nx">linePos</span><span class="p">:]</span>
<a id="__codelineno-16-16" name="__codelineno-16-16"></a><a href="#__codelineno-16-16"><span class="linenos" data-linenos="16 "></span></a><span class="w">        </span><span class="k">return</span>
<a id="__codelineno-16-17" name="__codelineno-16-17"></a><a href="#__codelineno-16-17"><span class="linenos" data-linenos="17 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-16-18" name="__codelineno-16-18"></a><a href="#__codelineno-16-18"><span class="linenos" data-linenos="18 "></span></a>
<a id="__codelineno-16-19" name="__codelineno-16-19"></a><a href="#__codelineno-16-19"><span class="linenos" data-linenos="19 "></span></a><span class="w">    </span><span class="c1">// 处理跨行插入的复杂逻辑</span>
<a id="__codelineno-16-20" name="__codelineno-16-20"></a><a href="#__codelineno-16-20"><span class="linenos" data-linenos="20 "></span></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-16-21" name="__codelineno-16-21"></a><a href="#__codelineno-16-21"><span class="linenos" data-linenos="21 "></span></a><span class="p">}</span>
<a id="__codelineno-16-22" name="__codelineno-16-22"></a><a href="#__codelineno-16-22"><span class="linenos" data-linenos="22 "></span></a>
<a id="__codelineno-16-23" name="__codelineno-16-23"></a><a href="#__codelineno-16-23"><span class="linenos" data-linenos="23 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">CharacterBasedText</span><span class="p">)</span><span class="w"> </span><span class="nx">Delete</span><span class="p">(</span><span class="nx">startPos</span><span class="p">,</span><span class="w"> </span><span class="nx">endPos</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-24" name="__codelineno-16-24"></a><a href="#__codelineno-16-24"><span class="linenos" data-linenos="24 "></span></a><span class="w">    </span><span class="c1">// 复杂的删除逻辑被封装在此方法内</span>
<a id="__codelineno-16-25" name="__codelineno-16-25"></a><a href="#__codelineno-16-25"><span class="linenos" data-linenos="25 "></span></a><span class="w">    </span><span class="nx">startLine</span><span class="p">,</span><span class="w"> </span><span class="nx">startCol</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">positionToLineAndColumn</span><span class="p">(</span><span class="nx">startPos</span><span class="p">)</span>
<a id="__codelineno-16-26" name="__codelineno-16-26"></a><a href="#__codelineno-16-26"><span class="linenos" data-linenos="26 "></span></a><span class="w">    </span><span class="nx">endLine</span><span class="p">,</span><span class="w"> </span><span class="nx">endCol</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">positionToLineAndColumn</span><span class="p">(</span><span class="nx">endPos</span><span class="p">)</span>
<a id="__codelineno-16-27" name="__codelineno-16-27"></a><a href="#__codelineno-16-27"><span class="linenos" data-linenos="27 "></span></a>
<a id="__codelineno-16-28" name="__codelineno-16-28"></a><a href="#__codelineno-16-28"><span class="linenos" data-linenos="28 "></span></a><span class="w">    </span><span class="c1">// 封装了跨行删除的所有复杂性</span>
<a id="__codelineno-16-29" name="__codelineno-16-29"></a><a href="#__codelineno-16-29"><span class="linenos" data-linenos="29 "></span></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-16-30" name="__codelineno-16-30"></a><a href="#__codelineno-16-30"><span class="linenos" data-linenos="30 "></span></a><span class="p">}</span>
<a id="__codelineno-16-31" name="__codelineno-16-31"></a><a href="#__codelineno-16-31"><span class="linenos" data-linenos="31 "></span></a>
<a id="__codelineno-16-32" name="__codelineno-16-32"></a><a href="#__codelineno-16-32"><span class="linenos" data-linenos="32 "></span></a><span class="c1">// 调用代码变得简单</span>
<a id="__codelineno-16-33" name="__codelineno-16-33"></a><a href="#__codelineno-16-33"><span class="linenos" data-linenos="33 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">handleUserKeypress</span><span class="p">(</span><span class="nx">text</span><span class="w"> </span><span class="o">*</span><span class="nx">CharacterBasedText</span><span class="p">,</span><span class="w"> </span><span class="nx">position</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">char</span><span class="w"> </span><span class="kt">rune</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-34" name="__codelineno-16-34"></a><a href="#__codelineno-16-34"><span class="linenos" data-linenos="34 "></span></a><span class="w">    </span><span class="nx">text</span><span class="p">.</span><span class="nx">Insert</span><span class="p">(</span><span class="nx">position</span><span class="p">,</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">char</span><span class="p">))</span>
<a id="__codelineno-16-35" name="__codelineno-16-35"></a><a href="#__codelineno-16-35"><span class="linenos" data-linenos="35 "></span></a><span class="p">}</span>
<a id="__codelineno-16-36" name="__codelineno-16-36"></a><a href="#__codelineno-16-36"><span class="linenos" data-linenos="36 "></span></a>
<a id="__codelineno-16-37" name="__codelineno-16-37"></a><a href="#__codelineno-16-37"><span class="linenos" data-linenos="37 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">deleteSelection</span><span class="p">(</span><span class="nx">text</span><span class="w"> </span><span class="o">*</span><span class="nx">CharacterBasedText</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-38" name="__codelineno-16-38"></a><a href="#__codelineno-16-38"><span class="linenos" data-linenos="38 "></span></a><span class="w">    </span><span class="nx">text</span><span class="p">.</span><span class="nx">Delete</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span><span class="w"> </span><span class="nx">end</span><span class="p">)</span>
<a id="__codelineno-16-39" name="__codelineno-16-39"></a><a href="#__codelineno-16-39"><span class="linenos" data-linenos="39 "></span></a><span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p>这个例子展示了：</p>
<ul>
<li><strong>行级接口</strong>将复杂性推给了上层模块，导致用户界面代码必须处理行的拆分和合并</li>
<li><strong>字符级接口</strong>将复杂性下推到文本类内部，简化了上层代码</li>
<li>虽然字符级接口使文本类的实现更复杂，但这种复杂性被封装，降低了系统整体复杂度</li>
</ul>
<p><strong>3.2 配置参数的问题</strong></p>
<p>配置参数是向上推移复杂性的典型例子：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">使用配置参数</label><label for="__tabbed_6_2">自适应的设计</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-go highlight"><span class="filename">Go</span><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><a href="#__codelineno-17-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="c1">// 使用配置参数的网络客户端</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><a href="#__codelineno-17-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">NetworkClient</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><a href="#__codelineno-17-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">    </span><span class="c1">// 暴露多个配置参数</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><a href="#__codelineno-17-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">    </span><span class="nx">RetryCount</span><span class="w">       </span><span class="kt">int</span><span class="w">    </span><span class="c1">// 重试次数</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a><a href="#__codelineno-17-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="w">    </span><span class="nx">RetryInterval</span><span class="w">    </span><span class="kt">int</span><span class="w">    </span><span class="c1">// 重试间隔(毫秒)</span>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a><a href="#__codelineno-17-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="w">    </span><span class="nx">ConnectionTimeout</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="c1">// 连接超时(毫秒)</span>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a><a href="#__codelineno-17-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="w">    </span><span class="nx">ReadTimeout</span><span class="w">      </span><span class="kt">int</span><span class="w">    </span><span class="c1">// 读取超时(毫秒)</span>
<a id="__codelineno-17-8" name="__codelineno-17-8"></a><a href="#__codelineno-17-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="w">    </span><span class="nx">WriteTimeout</span><span class="w">     </span><span class="kt">int</span><span class="w">    </span><span class="c1">// 写入超时(毫秒)</span>
<a id="__codelineno-17-9" name="__codelineno-17-9"></a><a href="#__codelineno-17-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="p">}</span>
<a id="__codelineno-17-10" name="__codelineno-17-10"></a><a href="#__codelineno-17-10"><span class="linenos" data-linenos="10 "></span></a>
<a id="__codelineno-17-11" name="__codelineno-17-11"></a><a href="#__codelineno-17-11"><span class="linenos" data-linenos="11 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewNetworkClient</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">NetworkClient</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-12" name="__codelineno-17-12"></a><a href="#__codelineno-17-12"><span class="linenos" data-linenos="12 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">NetworkClient</span><span class="p">{</span>
<a id="__codelineno-17-13" name="__codelineno-17-13"></a><a href="#__codelineno-17-13"><span class="linenos" data-linenos="13 "></span></a><span class="w">        </span><span class="nx">RetryCount</span><span class="p">:</span><span class="w">       </span><span class="mi">3</span><span class="p">,</span><span class="w">    </span><span class="c1">// 默认值</span>
<a id="__codelineno-17-14" name="__codelineno-17-14"></a><a href="#__codelineno-17-14"><span class="linenos" data-linenos="14 "></span></a><span class="w">        </span><span class="nx">RetryInterval</span><span class="p">:</span><span class="w">    </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="c1">// 默认1秒</span>
<a id="__codelineno-17-15" name="__codelineno-17-15"></a><a href="#__codelineno-17-15"><span class="linenos" data-linenos="15 "></span></a><span class="w">        </span><span class="nx">ConnectionTimeout</span><span class="p">:</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span>
<a id="__codelineno-17-16" name="__codelineno-17-16"></a><a href="#__codelineno-17-16"><span class="linenos" data-linenos="16 "></span></a><span class="w">        </span><span class="nx">ReadTimeout</span><span class="p">:</span><span class="w">      </span><span class="mi">3000</span><span class="p">,</span>
<a id="__codelineno-17-17" name="__codelineno-17-17"></a><a href="#__codelineno-17-17"><span class="linenos" data-linenos="17 "></span></a><span class="w">        </span><span class="nx">WriteTimeout</span><span class="p">:</span><span class="w">     </span><span class="mi">3000</span><span class="p">,</span>
<a id="__codelineno-17-18" name="__codelineno-17-18"></a><a href="#__codelineno-17-18"><span class="linenos" data-linenos="18 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-19" name="__codelineno-17-19"></a><a href="#__codelineno-17-19"><span class="linenos" data-linenos="19 "></span></a><span class="p">}</span>
<a id="__codelineno-17-20" name="__codelineno-17-20"></a><a href="#__codelineno-17-20"><span class="linenos" data-linenos="20 "></span></a>
<a id="__codelineno-17-21" name="__codelineno-17-21"></a><a href="#__codelineno-17-21"><span class="linenos" data-linenos="21 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">NetworkClient</span><span class="p">)</span><span class="w"> </span><span class="nx">SendRequest</span><span class="p">(</span><span class="nx">req</span><span class="w"> </span><span class="o">*</span><span class="nx">Request</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-22" name="__codelineno-17-22"></a><a href="#__codelineno-17-22"><span class="linenos" data-linenos="22 "></span></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">lastErr</span><span class="w"> </span><span class="kt">error</span>
<a id="__codelineno-17-23" name="__codelineno-17-23"></a><a href="#__codelineno-17-23"><span class="linenos" data-linenos="23 "></span></a>
<a id="__codelineno-17-24" name="__codelineno-17-24"></a><a href="#__codelineno-17-24"><span class="linenos" data-linenos="24 "></span></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">RetryCount</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-25" name="__codelineno-17-25"></a><a href="#__codelineno-17-25"><span class="linenos" data-linenos="25 "></span></a><span class="w">        </span><span class="c1">// 使用配置的超时设置</span>
<a id="__codelineno-17-26" name="__codelineno-17-26"></a><a href="#__codelineno-17-26"><span class="linenos" data-linenos="26 "></span></a><span class="w">        </span><span class="nx">conn</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">dialWithTimeout</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">ConnectionTimeout</span><span class="p">)</span>
<a id="__codelineno-17-27" name="__codelineno-17-27"></a><a href="#__codelineno-17-27"><span class="linenos" data-linenos="27 "></span></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-28" name="__codelineno-17-28"></a><a href="#__codelineno-17-28"><span class="linenos" data-linenos="28 "></span></a><span class="w">            </span><span class="nx">lastErr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">err</span>
<a id="__codelineno-17-29" name="__codelineno-17-29"></a><a href="#__codelineno-17-29"><span class="linenos" data-linenos="29 "></span></a><span class="w">            </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">RetryInterval</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
<a id="__codelineno-17-30" name="__codelineno-17-30"></a><a href="#__codelineno-17-30"><span class="linenos" data-linenos="30 "></span></a><span class="w">            </span><span class="k">continue</span>
<a id="__codelineno-17-31" name="__codelineno-17-31"></a><a href="#__codelineno-17-31"><span class="linenos" data-linenos="31 "></span></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-17-32" name="__codelineno-17-32"></a><a href="#__codelineno-17-32"><span class="linenos" data-linenos="32 "></span></a>
<a id="__codelineno-17-33" name="__codelineno-17-33"></a><a href="#__codelineno-17-33"><span class="linenos" data-linenos="33 "></span></a><span class="w">        </span><span class="c1">// 设置读写超时</span>
<a id="__codelineno-17-34" name="__codelineno-17-34"></a><a href="#__codelineno-17-34"><span class="linenos" data-linenos="34 "></span></a><span class="w">        </span><span class="nx">conn</span><span class="p">.</span><span class="nx">SetReadTimeout</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">ReadTimeout</span><span class="p">)</span>
<a id="__codelineno-17-35" name="__codelineno-17-35"></a><a href="#__codelineno-17-35"><span class="linenos" data-linenos="35 "></span></a><span class="w">        </span><span class="nx">conn</span><span class="p">.</span><span class="nx">SetWriteTimeout</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">WriteTimeout</span><span class="p">)</span>
<a id="__codelineno-17-36" name="__codelineno-17-36"></a><a href="#__codelineno-17-36"><span class="linenos" data-linenos="36 "></span></a>
<a id="__codelineno-17-37" name="__codelineno-17-37"></a><a href="#__codelineno-17-37"><span class="linenos" data-linenos="37 "></span></a><span class="w">        </span><span class="c1">// 发送请求逻辑...</span>
<a id="__codelineno-17-38" name="__codelineno-17-38"></a><a href="#__codelineno-17-38"><span class="linenos" data-linenos="38 "></span></a><span class="w">        </span><span class="c1">// ...</span>
<a id="__codelineno-17-39" name="__codelineno-17-39"></a><a href="#__codelineno-17-39"><span class="linenos" data-linenos="39 "></span></a>
<a id="__codelineno-17-40" name="__codelineno-17-40"></a><a href="#__codelineno-17-40"><span class="linenos" data-linenos="40 "></span></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<a id="__codelineno-17-41" name="__codelineno-17-41"></a><a href="#__codelineno-17-41"><span class="linenos" data-linenos="41 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-42" name="__codelineno-17-42"></a><a href="#__codelineno-17-42"><span class="linenos" data-linenos="42 "></span></a>
<a id="__codelineno-17-43" name="__codelineno-17-43"></a><a href="#__codelineno-17-43"><span class="linenos" data-linenos="43 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;failed after %d retries: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">RetryCount</span><span class="p">,</span><span class="w"> </span><span class="nx">lastErr</span><span class="p">)</span>
<a id="__codelineno-17-44" name="__codelineno-17-44"></a><a href="#__codelineno-17-44"><span class="linenos" data-linenos="44 "></span></a><span class="p">}</span>
<a id="__codelineno-17-45" name="__codelineno-17-45"></a><a href="#__codelineno-17-45"><span class="linenos" data-linenos="45 "></span></a>
<a id="__codelineno-17-46" name="__codelineno-17-46"></a><a href="#__codelineno-17-46"><span class="linenos" data-linenos="46 "></span></a><span class="c1">// 使用者必须决定正确的值</span>
<a id="__codelineno-17-47" name="__codelineno-17-47"></a><a href="#__codelineno-17-47"><span class="linenos" data-linenos="47 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-48" name="__codelineno-17-48"></a><a href="#__codelineno-17-48"><span class="linenos" data-linenos="48 "></span></a><span class="w">    </span><span class="nx">client</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewNetworkClient</span><span class="p">()</span>
<a id="__codelineno-17-49" name="__codelineno-17-49"></a><a href="#__codelineno-17-49"><span class="linenos" data-linenos="49 "></span></a><span class="w">    </span><span class="nx">client</span><span class="p">.</span><span class="nx">RetryCount</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span>
<a id="__codelineno-17-50" name="__codelineno-17-50"></a><a href="#__codelineno-17-50"><span class="linenos" data-linenos="50 "></span></a><span class="w">    </span><span class="nx">client</span><span class="p">.</span><span class="nx">RetryInterval</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2000</span>
<a id="__codelineno-17-51" name="__codelineno-17-51"></a><a href="#__codelineno-17-51"><span class="linenos" data-linenos="51 "></span></a>
<a id="__codelineno-17-52" name="__codelineno-17-52"></a><a href="#__codelineno-17-52"><span class="linenos" data-linenos="52 "></span></a><span class="w">    </span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">SendRequest</span><span class="p">(</span><span class="nx">newRequest</span><span class="p">())</span>
<a id="__codelineno-17-53" name="__codelineno-17-53"></a><a href="#__codelineno-17-53"><span class="linenos" data-linenos="53 "></span></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-17-54" name="__codelineno-17-54"></a><a href="#__codelineno-17-54"><span class="linenos" data-linenos="54 "></span></a><span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-go highlight"><span class="filename">Go</span><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><a href="#__codelineno-18-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="c1">// 自适应设计的网络客户端</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><a href="#__codelineno-18-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="kd">type</span><span class="w"> </span><span class="nx">AdaptiveNetworkClient</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><a href="#__codelineno-18-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">    </span><span class="c1">// 隐藏了大部分复杂性</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><a href="#__codelineno-18-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">    </span><span class="nx">responseTimeHistory</span><span class="w"> </span><span class="p">[]</span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a><a href="#__codelineno-18-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="w">    </span><span class="nx">historyMutex</span><span class="w">        </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a><a href="#__codelineno-18-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="p">}</span>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a><a href="#__codelineno-18-7"><span class="linenos" data-linenos=" 7 "></span></a>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a><a href="#__codelineno-18-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewAdaptiveNetworkClient</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">AdaptiveNetworkClient</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-9" name="__codelineno-18-9"></a><a href="#__codelineno-18-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">AdaptiveNetworkClient</span><span class="p">{</span>
<a id="__codelineno-18-10" name="__codelineno-18-10"></a><a href="#__codelineno-18-10"><span class="linenos" data-linenos="10 "></span></a><span class="w">        </span><span class="nx">responseTimeHistory</span><span class="p">:</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span>
<a id="__codelineno-18-11" name="__codelineno-18-11"></a><a href="#__codelineno-18-11"><span class="linenos" data-linenos="11 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-18-12" name="__codelineno-18-12"></a><a href="#__codelineno-18-12"><span class="linenos" data-linenos="12 "></span></a><span class="p">}</span>
<a id="__codelineno-18-13" name="__codelineno-18-13"></a><a href="#__codelineno-18-13"><span class="linenos" data-linenos="13 "></span></a>
<a id="__codelineno-18-14" name="__codelineno-18-14"></a><a href="#__codelineno-18-14"><span class="linenos" data-linenos="14 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">AdaptiveNetworkClient</span><span class="p">)</span><span class="w"> </span><span class="nx">SendRequest</span><span class="p">(</span><span class="nx">req</span><span class="w"> </span><span class="o">*</span><span class="nx">Request</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-15" name="__codelineno-18-15"></a><a href="#__codelineno-18-15"><span class="linenos" data-linenos="15 "></span></a><span class="w">    </span><span class="c1">// 计算当前条件下的最优重试间隔</span>
<a id="__codelineno-18-16" name="__codelineno-18-16"></a><a href="#__codelineno-18-16"><span class="linenos" data-linenos="16 "></span></a><span class="w">    </span><span class="nx">retryInterval</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">calculateOptimalRetryInterval</span><span class="p">()</span>
<a id="__codelineno-18-17" name="__codelineno-18-17"></a><a href="#__codelineno-18-17"><span class="linenos" data-linenos="17 "></span></a>
<a id="__codelineno-18-18" name="__codelineno-18-18"></a><a href="#__codelineno-18-18"><span class="linenos" data-linenos="18 "></span></a><span class="w">    </span><span class="c1">// 计算最佳重试次数基于网络状况</span>
<a id="__codelineno-18-19" name="__codelineno-18-19"></a><a href="#__codelineno-18-19"><span class="linenos" data-linenos="19 "></span></a><span class="w">    </span><span class="nx">retryCount</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">calculateOptimalRetryCount</span><span class="p">()</span>
<a id="__codelineno-18-20" name="__codelineno-18-20"></a><a href="#__codelineno-18-20"><span class="linenos" data-linenos="20 "></span></a>
<a id="__codelineno-18-21" name="__codelineno-18-21"></a><a href="#__codelineno-18-21"><span class="linenos" data-linenos="21 "></span></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">lastErr</span><span class="w"> </span><span class="kt">error</span>
<a id="__codelineno-18-22" name="__codelineno-18-22"></a><a href="#__codelineno-18-22"><span class="linenos" data-linenos="22 "></span></a><span class="w">    </span><span class="nx">startTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>
<a id="__codelineno-18-23" name="__codelineno-18-23"></a><a href="#__codelineno-18-23"><span class="linenos" data-linenos="23 "></span></a>
<a id="__codelineno-18-24" name="__codelineno-18-24"></a><a href="#__codelineno-18-24"><span class="linenos" data-linenos="24 "></span></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">retryCount</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-25" name="__codelineno-18-25"></a><a href="#__codelineno-18-25"><span class="linenos" data-linenos="25 "></span></a><span class="w">        </span><span class="c1">// 自动设置合理的超时时间</span>
<a id="__codelineno-18-26" name="__codelineno-18-26"></a><a href="#__codelineno-18-26"><span class="linenos" data-linenos="26 "></span></a><span class="w">        </span><span class="nx">timeout</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">calculateTimeout</span><span class="p">()</span>
<a id="__codelineno-18-27" name="__codelineno-18-27"></a><a href="#__codelineno-18-27"><span class="linenos" data-linenos="27 "></span></a>
<a id="__codelineno-18-28" name="__codelineno-18-28"></a><a href="#__codelineno-18-28"><span class="linenos" data-linenos="28 "></span></a><span class="w">        </span><span class="nx">conn</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">dialWithTimeout</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">,</span><span class="w"> </span><span class="nx">timeout</span><span class="p">)</span>
<a id="__codelineno-18-29" name="__codelineno-18-29"></a><a href="#__codelineno-18-29"><span class="linenos" data-linenos="29 "></span></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-30" name="__codelineno-18-30"></a><a href="#__codelineno-18-30"><span class="linenos" data-linenos="30 "></span></a><span class="w">            </span><span class="nx">lastErr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">err</span>
<a id="__codelineno-18-31" name="__codelineno-18-31"></a><a href="#__codelineno-18-31"><span class="linenos" data-linenos="31 "></span></a><span class="w">            </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">retryInterval</span><span class="p">)</span>
<a id="__codelineno-18-32" name="__codelineno-18-32"></a><a href="#__codelineno-18-32"><span class="linenos" data-linenos="32 "></span></a><span class="w">            </span><span class="k">continue</span>
<a id="__codelineno-18-33" name="__codelineno-18-33"></a><a href="#__codelineno-18-33"><span class="linenos" data-linenos="33 "></span></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-18-34" name="__codelineno-18-34"></a><a href="#__codelineno-18-34"><span class="linenos" data-linenos="34 "></span></a>
<a id="__codelineno-18-35" name="__codelineno-18-35"></a><a href="#__codelineno-18-35"><span class="linenos" data-linenos="35 "></span></a><span class="w">        </span><span class="c1">// 发送请求逻辑...</span>
<a id="__codelineno-18-36" name="__codelineno-18-36"></a><a href="#__codelineno-18-36"><span class="linenos" data-linenos="36 "></span></a><span class="w">        </span><span class="c1">// ...</span>
<a id="__codelineno-18-37" name="__codelineno-18-37"></a><a href="#__codelineno-18-37"><span class="linenos" data-linenos="37 "></span></a>
<a id="__codelineno-18-38" name="__codelineno-18-38"></a><a href="#__codelineno-18-38"><span class="linenos" data-linenos="38 "></span></a><span class="w">        </span><span class="c1">// 记录响应时间用于未来调整</span>
<a id="__codelineno-18-39" name="__codelineno-18-39"></a><a href="#__codelineno-18-39"><span class="linenos" data-linenos="39 "></span></a><span class="w">        </span><span class="nx">duration</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Since</span><span class="p">(</span><span class="nx">startTime</span><span class="p">)</span>
<a id="__codelineno-18-40" name="__codelineno-18-40"></a><a href="#__codelineno-18-40"><span class="linenos" data-linenos="40 "></span></a><span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">recordResponseTime</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span>
<a id="__codelineno-18-41" name="__codelineno-18-41"></a><a href="#__codelineno-18-41"><span class="linenos" data-linenos="41 "></span></a>
<a id="__codelineno-18-42" name="__codelineno-18-42"></a><a href="#__codelineno-18-42"><span class="linenos" data-linenos="42 "></span></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<a id="__codelineno-18-43" name="__codelineno-18-43"></a><a href="#__codelineno-18-43"><span class="linenos" data-linenos="43 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-18-44" name="__codelineno-18-44"></a><a href="#__codelineno-18-44"><span class="linenos" data-linenos="44 "></span></a>
<a id="__codelineno-18-45" name="__codelineno-18-45"></a><a href="#__codelineno-18-45"><span class="linenos" data-linenos="45 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;failed after %d retries: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">retryCount</span><span class="p">,</span><span class="w"> </span><span class="nx">lastErr</span><span class="p">)</span>
<a id="__codelineno-18-46" name="__codelineno-18-46"></a><a href="#__codelineno-18-46"><span class="linenos" data-linenos="46 "></span></a><span class="p">}</span>
<a id="__codelineno-18-47" name="__codelineno-18-47"></a><a href="#__codelineno-18-47"><span class="linenos" data-linenos="47 "></span></a>
<a id="__codelineno-18-48" name="__codelineno-18-48"></a><a href="#__codelineno-18-48"><span class="linenos" data-linenos="48 "></span></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">AdaptiveNetworkClient</span><span class="p">)</span><span class="w"> </span><span class="nx">calculateOptimalRetryInterval</span><span class="p">()</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-49" name="__codelineno-18-49"></a><a href="#__codelineno-18-49"><span class="linenos" data-linenos="49 "></span></a><span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">historyMutex</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<a id="__codelineno-18-50" name="__codelineno-18-50"></a><a href="#__codelineno-18-50"><span class="linenos" data-linenos="50 "></span></a><span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">historyMutex</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<a id="__codelineno-18-51" name="__codelineno-18-51"></a><a href="#__codelineno-18-51"><span class="linenos" data-linenos="51 "></span></a>
<a id="__codelineno-18-52" name="__codelineno-18-52"></a><a href="#__codelineno-18-52"><span class="linenos" data-linenos="52 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">responseTimeHistory</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-53" name="__codelineno-18-53"></a><a href="#__codelineno-18-53"><span class="linenos" data-linenos="53 "></span></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="w"> </span><span class="c1">// 默认值</span>
<a id="__codelineno-18-54" name="__codelineno-18-54"></a><a href="#__codelineno-18-54"><span class="linenos" data-linenos="54 "></span></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-18-55" name="__codelineno-18-55"></a><a href="#__codelineno-18-55"><span class="linenos" data-linenos="55 "></span></a>
<a id="__codelineno-18-56" name="__codelineno-18-56"></a><a href="#__codelineno-18-56"><span class="linenos" data-linenos="56 "></span></a><span class="w">    </span><span class="c1">// 基于历史响应时间计算最佳间隔</span>
<a id="__codelineno-18-57" name="__codelineno-18-57"></a><a href="#__codelineno-18-57"><span class="linenos" data-linenos="57 "></span></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-18-58" name="__codelineno-18-58"></a><a href="#__codelineno-18-58"><span class="linenos" data-linenos="58 "></span></a>
<a id="__codelineno-18-59" name="__codelineno-18-59"></a><a href="#__codelineno-18-59"><span class="linenos" data-linenos="59 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">optimalInterval</span>
<a id="__codelineno-18-60" name="__codelineno-18-60"></a><a href="#__codelineno-18-60"><span class="linenos" data-linenos="60 "></span></a><span class="p">}</span>
<a id="__codelineno-18-61" name="__codelineno-18-61"></a><a href="#__codelineno-18-61"><span class="linenos" data-linenos="61 "></span></a>
<a id="__codelineno-18-62" name="__codelineno-18-62"></a><a href="#__codelineno-18-62"><span class="linenos" data-linenos="62 "></span></a><span class="c1">// 其它自适应方法...</span>
<a id="__codelineno-18-63" name="__codelineno-18-63"></a><a href="#__codelineno-18-63"><span class="linenos" data-linenos="63 "></span></a>
<a id="__codelineno-18-64" name="__codelineno-18-64"></a><a href="#__codelineno-18-64"><span class="linenos" data-linenos="64 "></span></a><span class="c1">// 使用者不需要设置参数</span>
<a id="__codelineno-18-65" name="__codelineno-18-65"></a><a href="#__codelineno-18-65"><span class="linenos" data-linenos="65 "></span></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-66" name="__codelineno-18-66"></a><a href="#__codelineno-18-66"><span class="linenos" data-linenos="66 "></span></a><span class="w">    </span><span class="nx">client</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewAdaptiveNetworkClient</span><span class="p">()</span>
<a id="__codelineno-18-67" name="__codelineno-18-67"></a><a href="#__codelineno-18-67"><span class="linenos" data-linenos="67 "></span></a><span class="w">    </span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">SendRequest</span><span class="p">(</span><span class="nx">newRequest</span><span class="p">())</span>
<a id="__codelineno-18-68" name="__codelineno-18-68"></a><a href="#__codelineno-18-68"><span class="linenos" data-linenos="68 "></span></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-18-69" name="__codelineno-18-69"></a><a href="#__codelineno-18-69"><span class="linenos" data-linenos="69 "></span></a><span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<hr />
<p>这个对比说明：</p>
<ul>
<li>配置参数让用户必须决定正确的值，这通常很困难</li>
<li>自适应设计通过观察系统行为自动调整参数，下推了复杂性</li>
<li>自适应方法还能根据操作条件变化动态调整，而配置参数往往变得过时</li>
</ul>
<p><strong>3.3 配置参数的取舍</strong></p>
<table>
<thead>
<tr>
<th>优势</th>
<th>劣势</th>
</tr>
</thead>
<tbody>
<tr>
<td>允许用户根据特定需求调整系统</td>
<td>用户/管理员难以确定正确值</td>
</tr>
<tr>
<td>适用于领域知识在用户而非代码中的情况</td>
<td>成为逃避实现完整解决方案的借口</td>
</tr>
<tr>
<td>可以适应不同工作负载</td>
<td>参数容易过时</td>
</tr>
<tr>
<td></td>
<td>增加了文档和学习成本</td>
</tr>
</tbody>
</table>
<p><strong>4. 限制与平衡</strong></p>
<p>向下推移复杂性并非万能，需要谨慎应用：</p>
<ul>
<li>不应极端地将所有功能下推到单个类中</li>
<li>下推复杂性最有意义的条件：<ol>
<li>被下推的复杂性与类现有功能密切相关</li>
<li>下推会显著简化应用中的其他部分</li>
<li>下推简化了类的接口</li>
</ol>
</li>
<li>目标是<strong>最小化整体系统复杂性</strong>，而非局部优化</li>
</ul>
<p><strong>错误示例</strong>：在文本类中添加实现退格键功能的方法。虽然这下推了复杂性，但它：</p>
<ul>
<li>不会显著简化高层代码</li>
<li>用户界面知识与文本类核心功能无关</li>
<li>导致了不必要的信息泄漏</li>
</ul>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="March 18, 2025 10:30:28">March 18, 2025 10:30:28</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="February 24, 2025 20:29:31">February 24, 2025 20:29:31</span>
  </span>

    
    
    
  </aside>


  




                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../2411%E3%80%8A%E4%BA%BA%E6%9C%88%E7%A5%9E%E8%AF%9D%E3%80%8B/03init/" class="md-footer__link md-footer__link--prev" aria-label="Previous: 15~18">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                15~18
              </div>
            </div>
          </a>
        
        
          
          <a href="../02init/" class="md-footer__link md-footer__link--next" aria-label="Next: 09~15">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                09~15
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 catwithtudou
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/catwithtudou" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/catwithtudou" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9zm-24.8 373.8h39.1L151.1 88h-42z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            

  
    
  


  
    
  



  


<h4>Cookie consent</h4>
<p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" checked>
          <span class="task-list-indicator"></span>
          Google Analytics
        </label>
      </li>
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="github" checked>
          <span class="task-list-indicator"></span>
          GitHub
        </label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script>
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.path", "navigation.prune", "navigation.indexes", "navigation.top", "toc.integrate", "navigation.footer", "toc.follow", "search.suggest", "search.highlight", "search.share", "content.tabs.link", "content.code.annotation", "content.code.copy", "content.code.select", "header.autohide"], "search": "../../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>